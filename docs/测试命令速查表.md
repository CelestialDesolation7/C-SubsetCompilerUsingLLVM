# ToyC ç¼–è¯‘å™¨æµ‹è¯•å‘½ä»¤å¿«é€Ÿå‚è€ƒ

## ğŸ“ åŸºæœ¬å‘½ä»¤

### æ„å»º
```bash
make build          # ç¼–è¯‘ ToyC ç¼–è¯‘å™¨
make clean          # æ¸…ç†æ„å»ºäº§ç‰©
```

### å•æ–‡ä»¶ç¼–è¯‘
```bash
./toyc file.c --mode asm           # ç”Ÿæˆæ±‡ç¼–
./toyc file.c --mode ir            # ç”Ÿæˆ IR
./toyc file.c --mode ast           # æ˜¾ç¤º AST
./toyc file.c --mode all           # æ˜¾ç¤ºå…¨éƒ¨
./toyc file.c --mode asm -o out.s  # è¾“å‡ºåˆ°æ–‡ä»¶
```

## ğŸ§ª æ‰¹é‡æµ‹è¯•

### ç”Ÿæˆæ±‡ç¼–å’Œ IR
```bash
make test                                    # é»˜è®¤ç›®å½• (examples/compiler_inputs)
make test TEST_SRC_DIR=examples/single_func  # è‡ªå®šä¹‰ç›®å½•
make test TEST_SRC_DIR=examples/multi_func   # å¤šå‡½æ•°æµ‹è¯•
```

**è¾“å‡ºä½ç½®**: `test/asm/` å’Œ `test/ir/`

### éªŒè¯è¾“å‡ºæ­£ç¡®æ€§
```bash
make verify                                    # é»˜è®¤ç›®å½•
make verify TEST_SRC_DIR=examples/single_func  # è‡ªå®šä¹‰ç›®å½•
```

**éªŒè¯åŠŸèƒ½**:
- âœ… è‡ªåŠ¨ç¼–è¯‘ ToyC å’Œ Clang ç”Ÿæˆçš„æ±‡ç¼–
- âœ… ä½¿ç”¨ QEMU è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
- âœ… å¯¹æ¯”é€€å‡ºç å’Œè¾“å‡º
- âœ… æ˜¾ç¤ºé€šè¿‡/å¤±è´¥ç»Ÿè®¡

## ğŸ“‚ æµ‹è¯•ç›®å½•ç»“æ„

```
examples/
â”œâ”€â”€ compiler_inputs/    # åŸºç¡€æµ‹è¯•é›† (15ä¸ªç”¨ä¾‹)
â”œâ”€â”€ single_func/        # å•å‡½æ•°æµ‹è¯•
â””â”€â”€ multi_func/         # å¤šå‡½æ•°æµ‹è¯•
```

**æµ‹è¯•è¾“å‡º**:
```
test/
â”œâ”€â”€ asm/               # æ±‡ç¼–è¾“å‡º
â”‚   â”œâ”€â”€ *_toyc.s       # ToyC ç”Ÿæˆ
â”‚   â””â”€â”€ *_clang.s      # Clang ç”Ÿæˆï¼ˆå¯¹æ¯”ç”¨ï¼‰
â”œâ”€â”€ ir/                # LLVM IR è¾“å‡º
â”‚   â”œâ”€â”€ *_toyc.ll
â”‚   â””â”€â”€ *_clang.ll
â””â”€â”€ verify_temp/       # éªŒè¯ä¸´æ—¶æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
```

## ğŸ”§ è„šæœ¬ç›´æ¥è°ƒç”¨

```bash
# ç”Ÿæˆæ±‡ç¼–
bash scripts/generate_asm.sh [directory]

# ç”Ÿæˆ IR
bash scripts/generate_ir.sh [directory]

# éªŒè¯è¾“å‡º
bash scripts/verify_output.sh [directory]

# ç¤ºä¾‹
bash scripts/generate_asm.sh examples/single_func
bash scripts/verify_output.sh examples/multi_func
```

## ğŸ¯ å¸¸ç”¨å·¥ä½œæµ

### å·¥ä½œæµ 1: å¿«é€Ÿæµ‹è¯•
```bash
make build && make test
```

### å·¥ä½œæµ 2: å®Œæ•´éªŒè¯
```bash
make verify
```

### å·¥ä½œæµ 3: æµ‹è¯•ç‰¹å®šç›®å½•
```bash
make verify TEST_SRC_DIR=examples/single_func
```

### å·¥ä½œæµ 4: å¯¹æ¯”æµ‹è¯•
```bash
# æµ‹è¯•ç›®å½• A
make test TEST_SRC_DIR=examples/compiler_inputs
mv test/asm test/asm_backup_a

# æµ‹è¯•ç›®å½• B
make test TEST_SRC_DIR=examples/multi_func
mv test/asm test/asm_backup_b

# å¯¹æ¯”
diff -r test/asm_backup_a test/asm_backup_b
```

### å·¥ä½œæµ 5: è°ƒè¯•å•ä¸ªæ–‡ä»¶
```bash
# 1. ç”Ÿæˆæ±‡ç¼–
./toyc examples/compiler_inputs/01_minimal.c --mode asm -o test.s

# 2. æŸ¥çœ‹è¾“å‡º
cat test.s

# 3. å¯¹æ¯” Clang
clang -S --target=riscv32 -march=rv32i examples/compiler_inputs/01_minimal.c -o ref.s
diff test.s ref.s
```

## ğŸ› ï¸ ç¯å¢ƒè¦æ±‚

### å¿…éœ€ï¼ˆæ„å»ºå’ŒåŸºæœ¬æµ‹è¯•ï¼‰
- `g++` (C++20)
- `make`
- `bash`

### å¯é€‰ï¼ˆå¯¹æ¯”è¾“å‡ºï¼‰
- `clang` - ç”Ÿæˆå¯¹æ¯”ç”¨çš„ IR å’Œæ±‡ç¼–

### å¯é€‰ï¼ˆéªŒè¯åŠŸèƒ½ï¼‰
- `riscv32-unknown-elf-gcc` æˆ– `riscv64-unknown-elf-gcc` - RISC-V äº¤å‰ç¼–è¯‘å™¨
- `qemu-riscv32` æˆ– `qemu-riscv64` - QEMU RISC-V ç”¨æˆ·æ¨¡å¼

**å®‰è£…æ–¹æ³• (Ubuntu/Debian)**:
```bash
# åŸºç¡€å·¥å…·
sudo apt install build-essential clang

# éªŒè¯å·¥å…·ï¼ˆä¼šè‡ªåŠ¨æ£€æµ‹å¯ç”¨çš„å·¥å…·é“¾ï¼‰
sudo apt install gcc-riscv64-unknown-elf qemu-user
```

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æŸ¥çœ‹æŸä¸ªæµ‹è¯•çš„è¯¦ç»†è¾“å‡ºï¼Ÿ
```bash
# æŸ¥çœ‹ ToyC ç”Ÿæˆçš„æ±‡ç¼–
cat test/asm/01_minimal_toyc.s

# æŸ¥çœ‹ Clang ç”Ÿæˆçš„æ±‡ç¼–
cat test/asm/01_minimal_clang.s

# å¯¹æ¯”
diff test/asm/01_minimal_toyc.s test/asm/01_minimal_clang.s
```

### Q: éªŒè¯å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
```bash
# 1. æŸ¥çœ‹å¤±è´¥çš„æµ‹è¯•
make verify  # ä¼šæ˜¾ç¤ºå“ªäº›æµ‹è¯•å¤±è´¥

# 2. æ‰‹åŠ¨æ£€æŸ¥æ±‡ç¼–ä»£ç 
cat test/asm/failed_test_toyc.s
cat test/asm/failed_test_clang.s

# 3. æŸ¥çœ‹ IRï¼ˆå¯èƒ½é—®é¢˜åœ¨ IR ç”Ÿæˆé˜¶æ®µï¼‰
cat test/ir/failed_test_toyc.ll
```

### Q: å¦‚ä½•æ·»åŠ æ–°æµ‹è¯•ï¼Ÿ
```bash
# 1. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
cat > my_test.c << 'EOF'
int main() {
    return 42;
}
EOF

# 2. æ”¾åˆ°ä»»æ„ç›®å½•
mkdir my_tests
mv my_test.c my_tests/

# 3. è¿è¡Œæµ‹è¯•
make verify TEST_SRC_DIR=my_tests
```

### Q: æ¸…ç†æµ‹è¯•è¾“å‡ºï¼Ÿ
```bash
# æ¸…ç†æµ‹è¯•è¾“å‡º
rm -rf test/asm test/ir test/verify_temp

# æ¸…ç†å…¨éƒ¨
make clean
```

## ğŸ“Š æµ‹è¯•ç”¨ä¾‹åˆ—è¡¨

| æ–‡ä»¶ | åŠŸèƒ½ | éš¾åº¦ |
|------|------|------|
| 01_minimal.c | ç©º main | â­ |
| 02_assignment.c | èµ‹å€¼ | â­ |
| 03_if_else.c | æ¡ä»¶ | â­â­ |
| 04_while_break.c | å¾ªç¯ | â­â­ |
| 05_function_call.c | å‡½æ•°è°ƒç”¨ | â­â­ |
| 06_continue.c | continue | â­â­ |
| 07_scope_shadow.c | ä½œç”¨åŸŸ | â­â­â­ |
| 08_short_circuit.c | çŸ­è·¯æ±‚å€¼ | â­â­â­ |
| 09_recursion.c | é€’å½’ | â­â­â­ |
| 10_void_fn.c | void å‡½æ•° | â­â­ |
| 11_precedence.c | ä¼˜å…ˆçº§ | â­â­ |
| 12_division_check.c | é™¤æ³• | â­â­ |
| 13_scope_block.c | å—ä½œç”¨åŸŸ | â­â­â­ |
| 14_nested_if_while.c | åµŒå¥—æ§åˆ¶æµ | â­â­â­ |
| 15_multiple_return_paths.c | å¤šè¿”å›è·¯å¾„ | â­â­â­ |

## ğŸ’¡ æç¤º

- ä½¿ç”¨ `make verify` è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•
- æµ‹è¯•å¤±è´¥æ—¶æ£€æŸ¥ `test/asm/` ä¸‹çš„æ±‡ç¼–ä»£ç 
- å¯ä»¥ç”¨ `diff` æˆ– `code --diff` å¯¹æ¯”è¾“å‡º
- éªŒè¯éœ€è¦ RISC-V å·¥å…·é“¾å’Œ QEMU
- è¾“å‡ºä¼šè¦†ç›–ï¼Œéœ€è¦æ—¶è¯·å¤‡ä»½

---

**å¿«é€Ÿå¼€å§‹**: `make verify` âœ¨
