# ToyC ç¼–è¯‘å™¨ï¼šä»æ±‡ç¼–åˆ°éªŒè¯çš„å®Œæ•´æµç¨‹

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† ToyC ç¼–è¯‘å™¨é¡¹ç›®ä¸­ï¼Œä»ç”Ÿæˆæ±‡ç¼–ä»£ç åˆ°æœ€ç»ˆé€šè¿‡ `make verify` å®ŒæˆéªŒè¯çš„æ•´ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹ã€‚æ•´ä¸ªæµç¨‹æ¶‰åŠå¤šä¸ªé˜¶æ®µå’Œå·¥å…·çš„åä½œï¼Œç¡®ä¿ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç èƒ½å¤Ÿæ­£ç¡®è¿è¡Œå¹¶äº§ç”Ÿé¢„æœŸç»“æœã€‚

## ç›®å½•

1. [æ•´ä½“æµç¨‹å›¾](#æ•´ä½“æµç¨‹å›¾)
2. [é˜¶æ®µä¸€ï¼šç”Ÿæˆæ±‡ç¼–ä»£ç ](#é˜¶æ®µä¸€ç”Ÿæˆæ±‡ç¼–ä»£ç )
3. [é˜¶æ®µäºŒï¼šæ±‡ç¼–åˆ°å¯æ‰§è¡Œæ–‡ä»¶](#é˜¶æ®µäºŒæ±‡ç¼–åˆ°å¯æ‰§è¡Œæ–‡ä»¶)
4. [é˜¶æ®µä¸‰ï¼šè¿è¡Œä¸éªŒè¯](#é˜¶æ®µä¸‰è¿è¡Œä¸éªŒè¯)
5. [å…³é”®ç»„ä»¶è¯¦è§£](#å…³é”®ç»„ä»¶è¯¦è§£)
6. [å®Œæ•´ä»£ç è¿½è¸ªç¤ºä¾‹](#å®Œæ•´ä»£ç è¿½è¸ªç¤ºä¾‹)

---

## æ•´ä½“æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        make verify                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 0: ç¼–è¯‘å™¨æ„å»º (make build)                                  â”‚
â”‚  â”œâ”€ ç¼–è¯‘ toyc ä¸»ç¨‹åº                                              â”‚
â”‚  â””â”€ ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ ./toyc                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 1: æ±‡ç¼–ä»£ç ç”Ÿæˆ (make test)                                 â”‚
â”‚  â”œâ”€ generate_asm.sh: ToyC å’Œ Clang åˆ†åˆ«ç”Ÿæˆæ±‡ç¼–                  â”‚
â”‚  â”‚   â”œâ”€ toyc input.c --mode asm â†’ test/asm/input_toyc.s        â”‚
â”‚  â”‚   â””â”€ clang -S --target=riscv32 â†’ test/asm/input_clang.s     â”‚
â”‚  â””â”€ generate_ir.sh: ç”Ÿæˆ LLVM IR (å¯é€‰)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ 2: éªŒè¯è¾“å‡º (verify_output.sh)                              â”‚
â”‚  â”œâ”€ ç¼–è¯‘å¯åŠ¨ä»£ç  crt0.s â†’ crt0.o                                 â”‚
â”‚  â”œâ”€ é“¾æ¥ ToyC æ±‡ç¼–ï¼šcrt0.o + input_toyc.s â†’ input_toyc (ELF)    â”‚
â”‚  â”œâ”€ é“¾æ¥ Clang æ±‡ç¼–ï¼šcrt0.o + input_clang.s â†’ input_clang (ELF) â”‚
â”‚  â”œâ”€ QEMU è¿è¡Œ ToyC å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè·å–é€€å‡ºç å’Œè¾“å‡º                   â”‚
â”‚  â”œâ”€ QEMU è¿è¡Œ Clang å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè·å–é€€å‡ºç å’Œè¾“å‡º                  â”‚
â”‚  â””â”€ å¯¹æ¯”ä¸¤è€…çš„é€€å‡ºç å’Œè¾“å‡ºï¼Œåˆ¤æ–­æµ‹è¯•æ˜¯å¦é€šè¿‡                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                         âœ… æµ‹è¯•é€šè¿‡
```

---

## é˜¶æ®µä¸€ï¼šç”Ÿæˆæ±‡ç¼–ä»£ç 

### 1.1 Makefile ä¸­çš„ test ç›®æ ‡

**æ–‡ä»¶è·¯å¾„**: [Makefile](Makefile#L43-L62)

```makefile
# é»˜è®¤æµ‹è¯•ç›®å½•
TEST_SRC_DIR ?= examples/compiler_inputs

test: build
	@echo "Running tests on: $(TEST_SRC_DIR)"
	@if [ -f "scripts/generate_asm.sh" ]; then \
		bash scripts/generate_asm.sh "$(TEST_SRC_DIR)"; \
	else \
		echo "Error: scripts/generate_asm.sh not found"; \
		exit 1; \
	fi
	@if [ -f "scripts/generate_ir.sh" ]; then \
		bash scripts/generate_ir.sh "$(TEST_SRC_DIR)"; \
	else \
		echo "Error: scripts/generate_ir.sh not found"; \
		exit 1; \
	fi
	@echo "Tests completed successfully!"
	@echo "Output: test/asm/ and test/ir/"
```

**æ ¸å¿ƒé€»è¾‘**:
1. é¦–å…ˆç¡®ä¿ `toyc` ç¼–è¯‘å™¨å·²æ„å»ºï¼ˆä¾èµ– `build` ç›®æ ‡ï¼‰
2. è°ƒç”¨ `generate_asm.sh` è„šæœ¬ç”Ÿæˆæ±‡ç¼–ä»£ç 
3. è°ƒç”¨ `generate_ir.sh` è„šæœ¬ç”Ÿæˆ LLVM IRï¼ˆç”¨äºè°ƒè¯•å’Œå¯¹æ¯”ï¼‰
4. è¾“å‡ºæ–‡ä»¶å­˜æ”¾åœ¨ `test/asm/` å’Œ `test/ir/` ç›®å½•

### 1.2 generate_asm.sh è„šæœ¬è¯¦è§£

**æ–‡ä»¶è·¯å¾„**: [scripts/generate_asm.sh](scripts/generate_asm.sh)

```bash
#!/usr/bin/env bash

set -eu
if [[ -n "${BASH_VERSION:-}" ]]; then
    set -o pipefail
fi

# æ”¯æŒé€šè¿‡å‚æ•°æŒ‡å®šæºç›®å½•ï¼Œé»˜è®¤ä¸º examples/compiler_inputs
SRC_DIR="${1:-examples/compiler_inputs}"
OUT_DIR="test/asm"

# æ£€æŸ¥æºç›®å½•æ˜¯å¦å­˜åœ¨
if [[ ! -d "$SRC_DIR" ]]; then
  echo "Error: Source directory '$SRC_DIR' does not exist"
  exit 1
fi

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p "$OUT_DIR"

# å¤„ç†æ¯ä¸ª .c æ–‡ä»¶
for c in "$SRC_DIR"/*.c; do
  if [[ ! -f "$c" ]]; then
    echo "No .c files found in $SRC_DIR"
    exit 0
  fi
  
  base="$(basename "$c" .c)"
  c_file="$SRC_DIR/$base.c"

  echo ">>> å¤„ç† $base â€¦"

  # 1. ToyC ç”Ÿæˆ asm
  if [[ -f "./toyc" ]]; then
    ./toyc "$c" --mode asm --output "$OUT_DIR/${base}_toyc.s"
    echo "  ToyC â†’ asm/${base}_toyc.s"
  elif [[ -f "./toyc.exe" ]]; then
    ./toyc.exe "$c" --mode asm --output "$OUT_DIR/${base}_toyc.s"
    echo "  ToyC â†’ asm/${base}_toyc.s"
  else
    echo "  ToyC â†’ skipped (toyc not found)"
  fi

  # 2. Clang ç”Ÿæˆ asmï¼ˆä½œä¸ºå‚è€ƒæ ‡å‡†ï¼‰
  if [[ -f "$c_file" ]] && command -v clang >/dev/null 2>&1; then
    clang -S \
      --target=riscv32-unknown-elf \
      -march=rv32i -mabi=ilp32 \
      "$c_file" \
      -o "$OUT_DIR/${base}_clang.s"
    echo "  Clang â†’ asm/${base}_clang.s"
  else
    echo "  è·³è¿‡ Clangï¼ˆæœªæ‰¾åˆ° $base.c æˆ– clang æœªå®‰è£…ï¼‰"
  fi

  echo
done

echo "æ‰€æœ‰æ±‡ç¼–å·²ç”Ÿæˆåˆ° $OUT_DIR"
```

**å…³é”®ç‚¹**:
1. **åŒç¼–è¯‘å™¨ç­–ç•¥**: åŒæ—¶ä½¿ç”¨ ToyC å’Œ Clang ç”Ÿæˆæ±‡ç¼–ï¼ŒClang ä½œä¸ºå‚è€ƒæ ‡å‡†
2. **å‘½åçº¦å®š**: 
   - ToyC è¾“å‡º: `{base}_toyc.s`
   - Clang è¾“å‡º: `{base}_clang.s`
3. **RISC-V ç›®æ ‡**: 
   - ç›®æ ‡å¹³å°: `riscv32-unknown-elf`
   - æŒ‡ä»¤é›†æ¶æ„: `rv32i` (RISC-V 32ä½åŸºç¡€æ•´æ•°æŒ‡ä»¤é›†)
   - ABI: `ilp32` (æ•´æ•°å’Œé•¿æ•´æ•°éƒ½æ˜¯32ä½ï¼ŒæŒ‡é’ˆä¹Ÿæ˜¯32ä½)

### 1.3 ToyC ç¼–è¯‘å™¨çš„æ±‡ç¼–ç”Ÿæˆ

**æ–‡ä»¶è·¯å¾„**: [src/main.cpp](src/main.cpp#L156-L166)

```cpp
if (outputMode == "asm" || outputMode == "all")
{
    string assembly = generateRISCVAssembly(llvmIR);
    *out << assembly;
}
```

**ç¼–è¯‘æµç¨‹**:
1. **è¯æ³•åˆ†æ** (`lexer.cpp`): å°†æºä»£ç è½¬æ¢ä¸º token æµ
2. **è¯­æ³•åˆ†æ** (`parser.cpp`): æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ (AST)
3. **LLVM IR ç”Ÿæˆ** (`llvm_ir.cpp`): ä» AST ç”Ÿæˆ LLVM ä¸­é—´è¡¨ç¤º
4. **RISC-V æ±‡ç¼–ç”Ÿæˆ** (`riscv_gen.cpp`): ä» LLVM IR ç”Ÿæˆç›®æ ‡æ±‡ç¼–

**æ ¸å¿ƒä»£ç è·¯å¾„**: [src/riscv_gen.cpp](src/riscv_gen.cpp)

```cpp
std::string RISCVGenerator::generateRISCVAssembly(const std::string &llvmIR)
{
    // 1. è§£æ LLVM IRï¼Œæå–å‡½æ•°å®šä¹‰
    // 2. ä¸ºæ¯ä¸ªå‡½æ•°ç”Ÿæˆæ±‡ç¼–ä»£ç 
    // 3. è¿›è¡Œå¯„å­˜å™¨åˆ†é…ï¼ˆçº¿æ€§æ‰«æç®—æ³•ï¼‰
    // 4. ç”Ÿæˆæœ€ç»ˆçš„ RISC-V æ±‡ç¼–æŒ‡ä»¤
}
```

### 1.4 ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ç¤ºä¾‹

**è¾“å…¥ C ä»£ç **: [examples/compiler_inputs/01_minimal.c](examples/compiler_inputs/01_minimal.c)

```c
int main() {
    return 0;
}
```

**ToyC ç”Ÿæˆçš„æ±‡ç¼–**: [test/asm/01_minimal_toyc.s](test/asm/01_minimal_toyc.s)

```riscv
	.text
	.globl	main                            # -- Begin function main
main:                                   # @main
# %bb.0:
	addi	sp, sp, -16              # åˆ†é…æ ˆå¸§
	sw	ra, 12(sp)                      # ä¿å­˜è¿”å›åœ°å€
	sw	s0, 8(sp)                       # ä¿å­˜å¸§æŒ‡é’ˆ
	addi	s0, sp, 16               # è®¾ç½®æ–°çš„å¸§æŒ‡é’ˆ
	li	t1, 0                           # åŠ è½½ç«‹å³æ•° 0
	sw	t1, -12(s0)                     # å­˜å‚¨åˆ°æ ˆä¸Š
	li	a0, 0                           # è®¾ç½®è¿”å›å€¼ä¸º 0
	lw	ra, 12(sp)                      # æ¢å¤è¿”å›åœ°å€
	lw	s0, 8(sp)                       # æ¢å¤å¸§æŒ‡é’ˆ
	addi	sp, sp, 16               # é‡Šæ”¾æ ˆå¸§
	ret                                 # è¿”å›
                                        # -- End function
```

---

## é˜¶æ®µäºŒï¼šæ±‡ç¼–åˆ°å¯æ‰§è¡Œæ–‡ä»¶

### 2.1 å…³é”®ç»„ä»¶ï¼šå¯åŠ¨ä»£ç  (crt0.s)

**æ–‡ä»¶è·¯å¾„**: [scripts/crt0.s](scripts/crt0.s)

```riscv
# RISC-V 32-bit å¯åŠ¨ä»£ç 
# ç”¨äº QEMU ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œæµ‹è¯•ç¨‹åº

    .text
    .globl _start

_start:
    # ç›´æ¥è°ƒç”¨ main å‡½æ•°
    # QEMU ç”¨æˆ·æ¨¡å¼å·²æä¾›æœ‰æ•ˆçš„ spï¼Œæ— éœ€é¢å¤–åˆ†é…
    call    main
    
    # main è¿”å›åï¼Œè¿”å›å€¼åœ¨ a0 ä¸­
    # ä½¿ç”¨ Linux RISC-V exit ç³»ç»Ÿè°ƒç”¨
    # a0 = é€€å‡ºç ï¼ˆå·²ç”± main è®¾ç½®ï¼‰
    # a7 = ç³»ç»Ÿè°ƒç”¨å· (93 = exit)
    li      a7, 93
    ecall

    # ecall åç¨‹åºå·²ç»ˆæ­¢ï¼Œä»¥ä¸‹ä»£ç ä¸ä¼šæ‰§è¡Œ
    j       .
```

**å…³é”®ä½œç”¨**:
1. **ç¨‹åºå…¥å£ç‚¹**: `_start` æ˜¯ ELF å¯æ‰§è¡Œæ–‡ä»¶çš„é»˜è®¤å…¥å£ç‚¹
2. **è°ƒç”¨ main**: ç›´æ¥è°ƒç”¨ç”¨æˆ·çš„ `main` å‡½æ•°
3. **ç³»ç»Ÿè°ƒç”¨é€€å‡º**: 
   - `a0` å¯„å­˜å™¨: å­˜æ”¾ `main` å‡½æ•°çš„è¿”å›å€¼ï¼Œä½œä¸ºç¨‹åºé€€å‡ºç 
   - `a7` å¯„å­˜å™¨: ç³»ç»Ÿè°ƒç”¨å· 93 (Linux RISC-V çš„ exit ç³»ç»Ÿè°ƒç”¨)
   - `ecall`: è§¦å‘ç³»ç»Ÿè°ƒç”¨ï¼Œç»ˆæ­¢ç¨‹åº

**ä¸ºä»€ä¹ˆéœ€è¦ crt0.s**:
- æ ‡å‡† C è¿è¡Œæ—¶ (CRT) å¤ªè¿‡å¤æ‚ï¼ŒåŒ…å«å¤§é‡åˆå§‹åŒ–ä»£ç 
- æµ‹è¯•ç¯å¢ƒä¸‹åªéœ€è¦æœ€å°åŒ–çš„å¯åŠ¨ä»£ç 
- è‡ªå®šä¹‰å¯åŠ¨ä»£ç è®©æˆ‘ä»¬èƒ½ç²¾ç¡®æ§åˆ¶ç¨‹åºè¡Œä¸º

### 2.2 ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹

**æ–‡ä»¶è·¯å¾„**: [scripts/verify_output.sh](scripts/verify_output.sh#L113-L136)

```bash
# Clang ç›®æ ‡ä¸‰å…ƒç»„å’Œæ¶æ„å‚æ•°
CLANG_TARGET="riscv32-unknown-elf"
CLANG_ARCH="rv32im"
CLANG_ABI="ilp32"

# ç¼–è¯‘å¯åŠ¨æ–‡ä»¶
CRT0_OBJ="$TEMP_DIR/crt0.o"
if ! clang --target=$CLANG_TARGET -march=$CLANG_ARCH -mabi=$CLANG_ABI \
     -c "$CRT0_FILE" -o "$CRT0_OBJ" 2>/dev/null; then
  echo "Error: Failed to compile startup file with Clang"
  exit 1
fi
```

**ç¼–è¯‘å¯åŠ¨ä»£ç çš„æ­¥éª¤**:
1. ä½¿ç”¨ Clang ä½œä¸ºæ±‡ç¼–å™¨
2. æŒ‡å®šç›®æ ‡ä¸º `riscv32-unknown-elf`
3. æŒ‡ä»¤é›†æ‰©å±•ä¸º `rv32im` (åŸºç¡€æŒ‡ä»¤é›† + ä¹˜é™¤æ³•æ‰©å±•)
4. è¾“å‡ºç›®æ ‡æ–‡ä»¶ `crt0.o`

### 2.3 é“¾æ¥ç”¨æˆ·ç¨‹åº

**æ–‡ä»¶è·¯å¾„**: [scripts/verify_output.sh](scripts/verify_output.sh#L175-L196)

```bash
# æŸ¥æ‰¾ libgccï¼ˆæä¾›è½¯ä»¶é™¤æ³•ç­‰å†…ç½®å‡½æ•°ï¼‰
LIBGCC_PATH=""
if command -v riscv64-unknown-elf-gcc >/dev/null 2>&1; then
  LIBGCC_PATH=$(riscv64-unknown-elf-gcc -march=$CLANG_ARCH -mabi=$CLANG_ABI \
                -print-libgcc-file-name 2>/dev/null || true)
fi

# æ„å»ºé“¾æ¥å‚æ•°
LINK_LIBS=""
if [[ -n "$LIBGCC_PATH" ]]; then
  LINK_LIBS="$LIBGCC_PATH"
fi

# ç¼–è¯‘ ToyC ç”Ÿæˆçš„æ±‡ç¼–
toyc_exe="$TEMP_DIR/${base}_toyc"
if ! clang --target=$CLANG_TARGET -march=$CLANG_ARCH -mabi=$CLANG_ABI \
     -nostdlib "$CRT0_OBJ" "$toyc_asm" $LINK_LIBS -o "$toyc_exe" 2>/dev/null; then
  echo "  âŒ ToyC assembly compilation failed"
  FAILED=$((FAILED + 1))
  continue
fi
```

**é“¾æ¥è¿‡ç¨‹è¯¦è§£**:

1. **ç›®æ ‡æ–‡ä»¶ç»„åˆ**:
   ```
   crt0.o (å¯åŠ¨ä»£ç ) + input_toyc.s (ç”¨æˆ·æ±‡ç¼–) + libgcc.a (è¿è¡Œæ—¶åº“) â†’ executable
   ```

2. **é“¾æ¥é€‰é¡¹**:
   - `-nostdlib`: ä¸é“¾æ¥æ ‡å‡† C åº“ï¼Œä½¿ç”¨è‡ªå®šä¹‰å¯åŠ¨ä»£ç 
   - `--target=riscv32-unknown-elf`: ç›®æ ‡å¹³å°
   - `-march=rv32im`: æ”¯æŒæ•´æ•°ä¹˜é™¤æ³•æŒ‡ä»¤
   - `-mabi=ilp32`: 32ä½æ•´æ•°ã€é•¿æ•´æ•°å’ŒæŒ‡é’ˆçš„ ABI

3. **libgcc çš„ä½œç”¨**:
   - æä¾›è½¯ä»¶å®ç°çš„é™¤æ³•ã€å–æ¨¡ç­‰è¿ç®—ï¼ˆå½“ç¡¬ä»¶ä¸æ”¯æŒæ—¶ï¼‰
   - æä¾›å†…ç½®å‡½æ•°æ”¯æŒ
   - å¦‚æœæ‰¾ä¸åˆ° libgccï¼ŒåŒ…å«é™¤æ³•çš„æµ‹è¯•å¯èƒ½ä¼šå¤±è´¥

4. **è¾“å‡º ELF æ–‡ä»¶**:
   ```
   test/verify_temp/01_minimal_toyc  (RISC-V 32-bit ELF executable)
   ```

### 2.4 ELF å¯æ‰§è¡Œæ–‡ä»¶ç»“æ„

ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯æ ‡å‡†çš„ ELF (Executable and Linkable Format) æ ¼å¼ï¼š

```
ELF Header
  â”œâ”€ Magic: 0x7f 'E' 'L' 'F'
  â”œâ”€ Class: ELF32
  â”œâ”€ Machine: RISC-V
  â””â”€ Entry Point: _start

Program Headers
  â””â”€ LOAD segment (code + data)

Sections
  â”œâ”€ .text (ä»£ç æ®µ)
  â”‚   â”œâ”€ _start (å¯åŠ¨ä»£ç )
  â”‚   â””â”€ main (ç”¨æˆ·ä»£ç )
  â”œâ”€ .data (åˆå§‹åŒ–æ•°æ®)
  â””â”€ .symtab (ç¬¦å·è¡¨)
```

---

## é˜¶æ®µä¸‰ï¼šè¿è¡Œä¸éªŒè¯

### 3.1 QEMU ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿ

**æ–‡ä»¶è·¯å¾„**: [scripts/verify_output.sh](scripts/verify_output.sh#L83-L97)

```bash
# æ£€æŸ¥ QEMU RISC-V ç”¨æˆ·æ¨¡å¼
QEMU_CMD=""
if command -v qemu-riscv32 >/dev/null 2>&1; then
  QEMU_CMD="qemu-riscv32"
elif command -v qemu-riscv32-static >/dev/null 2>&1; then
  QEMU_CMD="qemu-riscv32-static"
elif command -v qemu-riscv64 >/dev/null 2>&1; then
  QEMU_CMD="qemu-riscv64"
  echo "Note: Using qemu-riscv64 for RV32 emulation"
else
  echo "Error: QEMU RISC-V user mode emulator not found"
  exit 1
fi
```

**QEMU ç”¨æˆ·æ¨¡å¼çš„ç‰¹ç‚¹**:
1. **ç›´æ¥è¿è¡Œ**: å¯ä»¥åœ¨ x86 ä¸»æœºä¸Šç›´æ¥è¿è¡Œ RISC-V å¯æ‰§è¡Œæ–‡ä»¶
2. **ç³»ç»Ÿè°ƒç”¨è½¬æ¢**: å°† RISC-V ç³»ç»Ÿè°ƒç”¨è½¬æ¢ä¸ºä¸»æœºç³»ç»Ÿè°ƒç”¨
3. **æ— éœ€å®Œæ•´ç³»ç»Ÿ**: ä¸éœ€è¦å¯åŠ¨å®Œæ•´çš„ RISC-V æ“ä½œç³»ç»Ÿ
4. **å¿«é€Ÿæµ‹è¯•**: éå¸¸é€‚åˆç¼–è¯‘å™¨æµ‹è¯•å’Œ CI/CD ç¯å¢ƒ

### 3.2 æ‰§è¡Œæµ‹è¯•ç¨‹åº

**æ–‡ä»¶è·¯å¾„**: [scripts/verify_output.sh](scripts/verify_output.sh#L198-L215)

```bash
# è¿è¡Œ ToyC ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
toyc_output=""
toyc_exitcode=0
if toyc_output=$($QEMU_CMD "$toyc_exe" 2>&1); then
  toyc_exitcode=$?
else
  toyc_exitcode=$?
fi

# è¿è¡Œ Clang ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
clang_output=""
clang_exitcode=0
if clang_output=$($QEMU_CMD "$clang_exe" 2>&1); then
  clang_exitcode=$?
else
  clang_exitcode=$?
fi
```

**æ‰§è¡Œæµç¨‹**:

1. **QEMU åŠ è½½ ELF**:
   ```
   qemu-riscv32 â†’ åŠ è½½ ELF æ–‡ä»¶ â†’ æ˜ å°„å†…å­˜ â†’ è®¾ç½®æ ˆæŒ‡é’ˆ
   ```

2. **è·³è½¬åˆ°å…¥å£ç‚¹**:
   ```
   PC = _start åœ°å€
   ```

3. **æ‰§è¡Œå¯åŠ¨ä»£ç **:
   ```riscv
   _start:
       call main        # è°ƒç”¨ç”¨æˆ· main å‡½æ•°
   ```

4. **æ‰§è¡Œç”¨æˆ·ä»£ç **:
   ```riscv
   main:
       addi sp, sp, -16  # åˆ†é…æ ˆå¸§
       # ... ç”¨æˆ·ä»£ç  ...
       li a0, 0          # è®¾ç½®è¿”å›å€¼
       ret               # è¿”å›åˆ° _start
   ```

5. **ç³»ç»Ÿè°ƒç”¨é€€å‡º**:
   ```riscv
   _start (è¿”å›å):
       li a7, 93         # exit ç³»ç»Ÿè°ƒç”¨å·
       ecall             # è§¦å‘ç³»ç»Ÿè°ƒç”¨
   ```

6. **QEMU å¤„ç†ç³»ç»Ÿè°ƒç”¨**:
   - è¯†åˆ« `a7=93` (exit ç³»ç»Ÿè°ƒç”¨)
   - ä» `a0` è·å–é€€å‡ºç 
   - ç»ˆæ­¢æ¨¡æ‹Ÿï¼Œè¿”å›é€€å‡ºç åˆ° Shell

### 3.3 ç»“æœå¯¹æ¯”

**æ–‡ä»¶è·¯å¾„**: [scripts/verify_output.sh](scripts/verify_output.sh#L217-L241)

```bash
# å¯¹æ¯”ç»“æœ
echo "  Clang  exit code: $clang_exitcode"
echo "  ToyC   exit code: $toyc_exitcode"

if [[ -n "$clang_output" ]]; then
  echo "  Clang  output: $clang_output"
fi
if [[ -n "$toyc_output" ]]; then
  echo "  ToyC   output: $toyc_output"
fi

# åˆ¤æ–­æ˜¯å¦ä¸€è‡´
if [[ "$toyc_exitcode" -eq "$clang_exitcode" ]] && \
   [[ "$toyc_output" == "$clang_output" ]]; then
  echo "  âœ… Result: CORRECT"
  PASSED=$((PASSED + 1))
else
  echo "  âŒ Result: INCORRECT"
  if [[ "$toyc_exitcode" -ne "$clang_exitcode" ]]; then
    echo "     Exit code mismatch: expected $clang_exitcode, got $toyc_exitcode"
  fi
  if [[ "$toyc_output" != "$clang_output" ]]; then
    echo "     Output mismatch"
    echo "     Expected: '$clang_output'"
    echo "     Got:      '$toyc_output'"
  fi
  FAILED=$((FAILED + 1))
fi
```

**éªŒè¯æ ‡å‡†**:
1. **é€€å‡ºç ä¸€è‡´**: ToyC å’Œ Clang ç”Ÿæˆçš„ç¨‹åºé€€å‡ºç å¿…é¡»ç›¸åŒ
2. **è¾“å‡ºä¸€è‡´**: æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºå¿…é¡»å®Œå…¨ä¸€è‡´
3. **åŒé‡ä¿è¯**: åŒæ—¶éªŒè¯é€»è¾‘æ­£ç¡®æ€§å’Œè¾“å‡ºç»“æœ

### 3.4 æœ€ç»ˆç»Ÿè®¡

**æ–‡ä»¶è·¯å¾„**: [scripts/verify_output.sh](scripts/verify_output.sh#L243-L253)

```bash
echo "========================================="
echo "  Verification Summary"
echo "========================================="
echo "Total tests:  $TOTAL"
echo "Passed:       $PASSED âœ…"
echo "Failed:       $FAILED âŒ"
echo ""

if [[ $FAILED -eq 0 ]] && [[ $TOTAL -gt 0 ]]; then
  echo "ğŸ‰ All tests passed!"
  exit 0
else
  echo "âš  Some tests failed"
  exit 1
fi
```

**è¾“å‡ºç¤ºä¾‹**:

```
=========================================
  ToyC Compiler Output Verification
=========================================
Source directory: examples/compiler_inputs
Assembly directory: test/asm
Compiler: clang --target=riscv32-unknown-elf
QEMU command: qemu-riscv32

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Testing: 01_minimal
  Clang  exit code: 0
  ToyC   exit code: 0
  âœ… Result: CORRECT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Testing: 02_assignment
  Clang  exit code: 42
  ToyC   exit code: 42
  âœ… Result: CORRECT
...
=========================================
  Verification Summary
=========================================
Total tests:  15
Passed:       15 âœ…
Failed:       0 âŒ

ğŸ‰ All tests passed!
```

---

## å…³é”®ç»„ä»¶è¯¦è§£

### 4.1 Makefile çš„ verify ç›®æ ‡

**æ–‡ä»¶è·¯å¾„**: [Makefile](Makefile#L64-L71)

```makefile
verify: test
	@echo ""
	@echo "Running output verification..."
	@if [ -f "scripts/verify_output.sh" ]; then \
		bash scripts/verify_output.sh "$(TEST_SRC_DIR)"; \
	else \
		echo "Error: scripts/verify_output.sh not found"; \
		exit 1; \
	fi
```

**ä¾èµ–å…³ç³»**:
```
verify â†’ test â†’ build â†’ compile source files
```

**æ‰§è¡Œæµç¨‹**:
1. è°ƒç”¨ `test` ç›®æ ‡ç”Ÿæˆæ±‡ç¼–
2. ç­‰å¾…æ±‡ç¼–ç”Ÿæˆå®Œæˆ
3. è°ƒç”¨ `verify_output.sh` è¿›è¡ŒéªŒè¯
4. è¿”å›éªŒè¯ç»“æœ

### 4.2 å·¥å…·é“¾æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ToyC ç¼–è¯‘å™¨  â”‚
â”‚  (C++ å®ç°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç”Ÿæˆ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RISC-V æ±‡ç¼–   â”‚     â”‚   Clang ç¼–è¯‘å™¨ â”‚
â”‚ (.s æ–‡ä»¶)     â”‚â—„â”€â”€â”€â”€â”‚  (å‚è€ƒæ ‡å‡†)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ä¸ crt0.o é“¾æ¥
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clang é“¾æ¥å™¨  â”‚
â”‚  + libgcc     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ELF å¯æ‰§è¡Œ   â”‚
â”‚  RISC-V 32ä½  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ è¿è¡Œ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     QEMU      â”‚
â”‚ (ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€€å‡ºç  + è¾“å‡º â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ å¯¹æ¯”
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éªŒè¯ç»“æœ      â”‚
â”‚ âœ… / âŒ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 å…³é”®å¯„å­˜å™¨çº¦å®š

**RISC-V è°ƒç”¨çº¦å®š**:

| å¯„å­˜å™¨ | åˆ«å | ç”¨é€” | è°ƒç”¨è€…/è¢«è°ƒç”¨è€…ä¿å­˜ |
|--------|------|------|-------------------|
| x0 | zero | å¸¸é‡ 0 | - |
| x1 | ra | è¿”å›åœ°å€ | è°ƒç”¨è€… |
| x2 | sp | æ ˆæŒ‡é’ˆ | è¢«è°ƒç”¨è€… |
| x8 | s0/fp | å¸§æŒ‡é’ˆ | è¢«è°ƒç”¨è€… |
| x10-x11 | a0-a1 | å‡½æ•°å‚æ•°/è¿”å›å€¼ | è°ƒç”¨è€… |
| x12-x17 | a2-a7 | å‡½æ•°å‚æ•°/ç³»ç»Ÿè°ƒç”¨ | è°ƒç”¨è€… |
| x5-x7, x28-x31 | t0-t6 | ä¸´æ—¶å¯„å­˜å™¨ | è°ƒç”¨è€… |

**ç³»ç»Ÿè°ƒç”¨çº¦å®š**:
- `a7`: ç³»ç»Ÿè°ƒç”¨å·
- `a0-a5`: ç³»ç»Ÿè°ƒç”¨å‚æ•°
- `a0`: ç³»ç»Ÿè°ƒç”¨è¿”å›å€¼

### 4.4 å†…å­˜å¸ƒå±€

**QEMU ç”¨æˆ·æ¨¡å¼å†…å­˜å¸ƒå±€**:

```
0xFFFFFFFF â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   å†…æ ¸ç©ºé—´   â”‚
0xC0000000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚     æ ˆ       â”‚ â† sp (ç”± QEMU åˆå§‹åŒ–)
           â”‚      â†“       â”‚
           â”‚             â”‚
           â”‚      â†‘       â”‚
           â”‚     å †       â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚   .bss      â”‚ (æœªåˆå§‹åŒ–æ•°æ®)
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚   .data     â”‚ (åˆå§‹åŒ–æ•°æ®)
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚   .text     â”‚ (ä»£ç æ®µ)
0x00010000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† ELF åŠ è½½åœ°å€
           â”‚   ä¿ç•™      â”‚
0x00000000 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´ä»£ç è¿½è¸ªç¤ºä¾‹

è®©æˆ‘ä»¬ä»¥ `01_minimal.c` ä¸ºä¾‹ï¼Œå®Œæ•´è¿½è¸ªä» C ä»£ç åˆ°éªŒè¯é€šè¿‡çš„å…¨è¿‡ç¨‹ã€‚

### 5.1 æºä»£ç 

**æ–‡ä»¶**: [examples/compiler_inputs/01_minimal.c](examples/compiler_inputs/01_minimal.c)

```c
int main() {
    return 0;
}
```

### 5.2 æ‰§è¡Œ make verify

```bash
$ make verify
```

#### æ­¥éª¤ 1: ç¼–è¯‘ ToyC ç¼–è¯‘å™¨

```bash
g++ -std=c++20 -O2 -Wall -c src/ast.cpp -o build/ast.o
g++ -std=c++20 -O2 -Wall -c src/lexer.cpp -o build/lexer.o
g++ -std=c++20 -O2 -Wall -c src/llvm_ir.cpp -o build/llvm_ir.o
g++ -std=c++20 -O2 -Wall -c src/main.cpp -o build/main.o
g++ -std=c++20 -O2 -Wall -c src/parser.cpp -o build/parser.o
g++ -std=c++20 -O2 -Wall -c src/ra_linear_scan.cpp -o build/ra_linear_scan.o
g++ -std=c++20 -O2 -Wall -c src/riscv_gen.cpp -o build/riscv_gen.o
g++ -std=c++20 -O2 -Wall build/*.o -o toyc
```

#### æ­¥éª¤ 2: ç”Ÿæˆæ±‡ç¼–ä»£ç 

**è°ƒç”¨**: `bash scripts/generate_asm.sh examples/compiler_inputs`

**ToyC ç”Ÿæˆæ±‡ç¼–**:
```bash
./toyc examples/compiler_inputs/01_minimal.c --mode asm \
  --output test/asm/01_minimal_toyc.s
```

**ToyC å†…éƒ¨æµç¨‹**:

1. **è¯æ³•åˆ†æ** ([src/lexer.cpp](src/lexer.cpp)):
   ```
   int main() { return 0; }
   â†“
   [INT] [ID:main] [LPAREN] [RPAREN] [LBRACE] [RETURN] [NUM:0] [SEMI] [RBRACE]
   ```

2. **è¯­æ³•åˆ†æ** ([src/parser.cpp](src/parser.cpp)):
   ```
   CompUnit
   â””â”€ FuncDef
      â”œâ”€ ReturnType: int
      â”œâ”€ Name: main
      â”œâ”€ Params: []
      â””â”€ Body: BlockStmt
         â””â”€ ReturnStmt
            â””â”€ Value: 0
   ```

3. **LLVM IR ç”Ÿæˆ** ([src/llvm_ir.cpp](src/llvm_ir.cpp)):
   ```llvm
   define dso_local i32 @main() {
   entry:
     %retval = alloca i32
     store i32 0, ptr %retval
     ret i32 0
   }
   ```

4. **RISC-V æ±‡ç¼–ç”Ÿæˆ** ([src/riscv_gen.cpp](src/riscv_gen.cpp)):
   ```riscv
   	.text
   	.globl	main
   main:
   	addi	sp, sp, -16
   	sw	ra, 12(sp)
   	sw	s0, 8(sp)
   	addi	s0, sp, 16
   	li	t1, 0
   	sw	t1, -12(s0)
   	li	a0, 0
   	lw	ra, 12(sp)
   	lw	s0, 8(sp)
   	addi	sp, sp, 16
   	ret
   ```

**Clang ç”Ÿæˆæ±‡ç¼–**:
```bash
clang -S --target=riscv32-unknown-elf -march=rv32i -mabi=ilp32 \
  examples/compiler_inputs/01_minimal.c \
  -o test/asm/01_minimal_clang.s
```

#### æ­¥éª¤ 3: éªŒè¯è¾“å‡º

**è°ƒç”¨**: `bash scripts/verify_output.sh examples/compiler_inputs`

**3.1 ç¼–è¯‘å¯åŠ¨ä»£ç **:
```bash
clang --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
  -c scripts/crt0.s -o test/verify_temp/crt0.o
```

**3.2 é“¾æ¥ ToyC å¯æ‰§è¡Œæ–‡ä»¶**:
```bash
clang --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
  -nostdlib \
  test/verify_temp/crt0.o \
  test/asm/01_minimal_toyc.s \
  /path/to/libgcc.a \
  -o test/verify_temp/01_minimal_toyc
```

**é“¾æ¥è¿‡ç¨‹è¯¦è§£**:
```
crt0.o:
  _start:
    call main
    li a7, 93
    ecall

01_minimal_toyc.s:
  main:
    ... (ç”¨æˆ·ä»£ç )
    li a0, 0
    ret

é“¾æ¥å:
  _start â†’ main â†’ ret to _start â†’ ecall (exit with a0=0)
```

**3.3 è¿è¡Œ ToyC å¯æ‰§è¡Œæ–‡ä»¶**:
```bash
$ qemu-riscv32 test/verify_temp/01_minimal_toyc
$ echo $?
0
```

**QEMU æ‰§è¡Œæµç¨‹**:

1. **åŠ è½½ ELF**:
   - è¯»å– ELF header
   - æ˜ å°„ .text æ®µåˆ°å†…å­˜
   - è®¾ç½® PC = _start åœ°å€
   - åˆå§‹åŒ– sp (æ ˆæŒ‡é’ˆ)

2. **æ‰§è¡Œ _start**:
   ```riscv
   _start:
       call main      # PC â†’ main, ra = ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€
   ```

3. **æ‰§è¡Œ main**:
   ```riscv
   main:
       addi sp, sp, -16    # sp = sp - 16 (åˆ†é…æ ˆå¸§)
       sw   ra, 12(sp)     # ä¿å­˜è¿”å›åœ°å€åˆ°æ ˆ
       sw   s0, 8(sp)      # ä¿å­˜å¸§æŒ‡é’ˆåˆ°æ ˆ
       addi s0, sp, 16     # s0 = sp + 16 (æ–°å¸§æŒ‡é’ˆ)
       li   t1, 0          # t1 = 0
       sw   t1, -12(s0)    # å­˜å‚¨åˆ°æ ˆ (retval)
       li   a0, 0          # a0 = 0 (è¿”å›å€¼)
       lw   ra, 12(sp)     # æ¢å¤è¿”å›åœ°å€
       lw   s0, 8(sp)      # æ¢å¤å¸§æŒ‡é’ˆ
       addi sp, sp, 16     # sp = sp + 16 (é‡Šæ”¾æ ˆå¸§)
       ret                 # PC = ra (è¿”å›åˆ° _start)
   ```

4. **è¿”å›åˆ° _start**:
   ```riscv
   _start (ç»§ç»­):
       li   a7, 93         # a7 = 93 (exit ç³»ç»Ÿè°ƒç”¨å·)
       ecall               # è§¦å‘ç³»ç»Ÿè°ƒç”¨
   ```

5. **QEMU å¤„ç† ecall**:
   - æ£€æµ‹åˆ°ç³»ç»Ÿè°ƒç”¨ 93 (exit)
   - è¯»å– a0 = 0 (é€€å‡ºç )
   - ç»ˆæ­¢æ¨¡æ‹Ÿ
   - å‘ Shell è¿”å›é€€å‡ºç  0

**3.4 è¿è¡Œ Clang å¯æ‰§è¡Œæ–‡ä»¶**:
```bash
$ qemu-riscv32 test/verify_temp/01_minimal_clang
$ echo $?
0
```

**3.5 å¯¹æ¯”ç»“æœ**:
```
Clang  exit code: 0
ToyC   exit code: 0
Clang  output: (empty)
ToyC   output: (empty)

âœ… Result: CORRECT
```

#### æ­¥éª¤ 4: æœ€ç»ˆç»Ÿè®¡

```
=========================================
  Verification Summary
=========================================
Total tests:  15
Passed:       15 âœ…
Failed:       0 âŒ

ğŸ‰ All tests passed!
```

### 5.3 æ›´å¤æ‚çš„ç¤ºä¾‹ï¼šå‡½æ•°è°ƒç”¨

**æ–‡ä»¶**: [examples/compiler_inputs/05_function_call.c](examples/compiler_inputs/05_function_call.c)

```c
int add(int a, int b) {
    return a + b;
}

int main() {
    int x = 10;
    int y = 20;
    int z = add(x, y);
    return z;
}
```

**å…³é”®æ±‡ç¼–ç‰‡æ®µ** (ToyC ç”Ÿæˆ):

```riscv
add:
    addi sp, sp, -16
    sw   ra, 12(sp)
    sw   s0, 8(sp)
    addi s0, sp, 16
    sw   a0, -12(s0)    # å‚æ•° a
    sw   a1, -16(s0)    # å‚æ•° b
    lw   t1, -12(s0)    # åŠ è½½ a
    lw   t2, -16(s0)    # åŠ è½½ b
    add  t3, t1, t2     # a + b
    mv   a0, t3         # è¿”å›å€¼
    lw   ra, 12(sp)
    lw   s0, 8(sp)
    addi sp, sp, 16
    ret

main:
    addi sp, sp, -32
    sw   ra, 28(sp)
    sw   s0, 24(sp)
    addi s0, sp, 32
    li   t1, 10
    sw   t1, -12(s0)    # x = 10
    li   t2, 20
    sw   t2, -16(s0)    # y = 20
    lw   a0, -12(s0)    # ç¬¬ä¸€ä¸ªå‚æ•°
    lw   a1, -16(s0)    # ç¬¬äºŒä¸ªå‚æ•°
    call add            # è°ƒç”¨ add
    sw   a0, -20(s0)    # z = add(x, y)
    lw   a0, -20(s0)    # è¿”å› z
    lw   ra, 28(sp)
    lw   s0, 24(sp)
    addi sp, sp, 32
    ret
```

**QEMU æ‰§è¡Œæµç¨‹**:

1. `_start` â†’ `call main`
2. `main` åˆ†é…æ ˆå¸§ï¼Œè®¾ç½® x=10, y=20
3. `main` è®¾ç½®å‚æ•° a0=10, a1=20
4. `main` â†’ `call add`
5. `add` è®¡ç®— 10+20=30ï¼Œè®¾ç½® a0=30
6. `add` â†’ `ret` (è¿”å›åˆ° main)
7. `main` ä¿å­˜è¿”å›å€¼åˆ° z
8. `main` è®¾ç½® a0=30 (è¿”å›å€¼)
9. `main` â†’ `ret` (è¿”å›åˆ° _start)
10. `_start` â†’ `ecall` é€€å‡ºï¼Œé€€å‡ºç =30

**éªŒè¯ç»“æœ**:
```
Testing: 05_function_call
  Clang  exit code: 30
  ToyC   exit code: 30
  âœ… Result: CORRECT
```

