# æ±‡ç¼–åˆ°éªŒè¯å®Œæ•´æµç¨‹

## æ€»è§ˆï¼šç«¯åˆ°ç«¯éªŒè¯æµæ°´çº¿

```
æºæ–‡ä»¶ (.c)
    â”‚
    â”œâ”€â”€ ToyC ç¼–è¯‘å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   toyc input.c -o output.s                      â”‚  æ±‡ç¼–è¾“å‡º
    â”‚                                                  â”‚
    â”œâ”€â”€ Clang å‚è€ƒç¼–è¯‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚   clang -S --target=riscv32 ...                 â”‚â”‚  å‚è€ƒæ±‡ç¼–
    â”‚                                                  â”‚â”‚
    â–¼                                                  â–¼â–¼
test/asm/XX_toyc.s                test/asm/XX_clang.s
    â”‚                                      â”‚
    â”œâ”€â”€ crt0.s (å¯åŠ¨ä»£ç ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                      â”‚
    â–¼                                      â–¼
Clang æ±‡ç¼–+é“¾æ¥                 Clang æ±‡ç¼–+é“¾æ¥
    â”‚                                      â”‚
    â–¼                                      â–¼
XX_toyc (ELF)                   XX_clang (ELF)
    â”‚                                      â”‚
    â–¼                                      â–¼
QEMU riscv32 è¿è¡Œ              QEMU riscv32 è¿è¡Œ
    â”‚                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€ å¯¹æ¯”é€€å‡ºç  + è¾“å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
               PASS / FAIL
```

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»ä»æ±‡ç¼–æ–‡ä»¶ç”Ÿæˆåˆ°è¾“å‡ºéªŒè¯çš„å®Œæ•´å·¥å…·é“¾æµç¨‹ï¼ŒåŒ…å«æ‰€æœ‰æ„å»ºå‘½ä»¤ã€è„šæœ¬é€»è¾‘å’Œå…³é”®åŸç†ã€‚

---

## æ„å»ºç³»ç»Ÿæ¦‚è§ˆ

### Makefile ç›®æ ‡

é¡¹ç›®ä½¿ç”¨ [Makefile](../Makefile) ä½œä¸ºé¡¶å±‚å…¥å£ï¼Œå°è£… CMake æ„å»ºå’Œæ‰€æœ‰æµ‹è¯•/éªŒè¯æ“ä½œï¼š

| ç›®æ ‡ | è¯´æ˜ | ç¯å¢ƒè¦æ±‚ |
|------|------|---------|
| `make` / `make build` | ç¼–è¯‘é¡¹ç›®ï¼ˆè‡ªåŠ¨æ£€æµ‹å¹³å°ï¼‰ | CMake + g++13 (MinGW æˆ– Linux) |
| `make test` | è¿è¡Œ 36 ä¸ªå†…ç½®å•å…ƒæµ‹è¯• | ä»…éœ€ç¼–è¯‘åçš„ `toyc_test` |
| `make generate-asm` | æ‰¹é‡ç”Ÿæˆ ToyC + Clang RISC-V æ±‡ç¼–ï¼ˆä¸é‡æ–°ç¼–è¯‘ï¼‰ | WSL/Linux + clang |
| `make generate-ir` | æ‰¹é‡ç”Ÿæˆ ToyC + Clang LLVM IRï¼ˆä¸é‡æ–°ç¼–è¯‘ï¼‰ | WSL/Linux + clang |
| `make verify` | ç«¯åˆ°ç«¯éªŒè¯ï¼ˆæ±‡ç¼–â†’é“¾æ¥â†’è¿è¡Œâ†’å¯¹æ¯”ï¼‰ | WSL/Linux + clang + qemu-user |
| `make debug FILE=xx.c` | å•æ–‡ä»¶è°ƒè¯•ï¼ˆAST/IR/ASM + éªŒè¯ï¼‰ï¼ˆä¸é‡æ–°ç¼–è¯‘ï¼‰ | åŒä¸Š |
| `make clean` | æ¸…ç† `build/`ã€`build-linux/` å’Œ `test/` | â€” |

> **è·¨å¹³å°è¯´æ˜**: Makefile é€šè¿‡ `uname -s` è‡ªåŠ¨æ£€æµ‹è¿è¡Œç¯å¢ƒã€‚
> Windows/MinGW æ„å»ºåˆ° `build/`ï¼ŒLinux/WSL æ„å»ºåˆ° `build-linux/`ï¼Œä¸¤å¥—ç¼“å­˜äº’ä¸å†²çªã€‚
> `generate-asm`ã€`generate-ir`ã€`debug` ç­‰ WSL ç›®æ ‡ä¸ä¼šè§¦å‘é‡æ–°ç¼–è¯‘ï¼Œè€Œæ˜¯é€šè¿‡ `check-toyc` ç›®æ ‡æ£€æŸ¥å·²æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæœç´¢ `build-linux/toyc`ã€`build/toyc`ã€`build/toyc.exe`ï¼‰ã€‚

### ç¼–è¯‘æµç¨‹

```makefile
# Makefile é€šè¿‡ uname -s è‡ªåŠ¨æ£€æµ‹å¹³å°
UNAME_S := $(shell uname -s 2>/dev/null || echo Windows)
# Linux/WSL â†’ BUILD_DIR = build-linux
# Windows   â†’ BUILD_DIR = build

build:
# Linux/WSL:
	@cmake -S . -B $(BUILD_DIR)
# Windows (æŒ‰ä¼˜å…ˆçº§å°è¯•):
	@cmake -S . -B $(BUILD_DIR) -G Ninja 2>/dev/null \
	 || cmake -S . -B $(BUILD_DIR) -G "MinGW Makefiles" 2>/dev/null \
	 || cmake -S . -B $(BUILD_DIR)
# å…±åŒ:
	@cmake --build $(BUILD_DIR) --parallel
```

Windows ä¸ŠæŒ‰ä¼˜å…ˆçº§å°è¯•ä¸‰ç§ç”Ÿæˆå™¨ï¼šNinja â†’ MinGW Makefiles â†’ é»˜è®¤ã€‚Linux/WSL ä¸‹ç›´æ¥ä½¿ç”¨ Unix Makefilesã€‚

ç¼–è¯‘äº§ç‰©ï¼š
- **Windows**: `build/toyc.exe`ã€`build/toyc_test.exe`
- **Linux/WSL**: `build-linux/toyc`ã€`build-linux/toyc_test`

ä¸¤å¥—æ„å»ºç›®å½•äº’ä¸å¹²æ‰°ï¼Œé¿å…äº† `wsl make` è§¦å‘ cmake æ—¶ Windows CMakeCache ä¸ WSL è·¯å¾„å†²çªçš„é—®é¢˜ã€‚

---

## é˜¶æ®µ 1ï¼šå†…ç½®æµ‹è¯•ï¼ˆ`make test`ï¼‰

```makefile
test: build
	@./$(BUILD_DIR)/toyc_test $(SRC_DIR)
```

`toyc_test` æ˜¯ [unified_test.cpp](../src/unified_test.cpp) ç¼–è¯‘å‡ºçš„æµ‹è¯•ç¨‹åºï¼ŒåŒ…å« 36 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š
- 12 ä¸ª **IR æµ‹è¯•**ï¼šå¯¹ `.c` æ–‡ä»¶ç”Ÿæˆ IR å¹¶åŒ¹é…æœŸæœ›æ¨¡å¼
- 24 ä¸ª **ASM æµ‹è¯•**ï¼šå¯¹ `.c` æ–‡ä»¶ç”Ÿæˆæ±‡ç¼–å¹¶æ£€æŸ¥å…³é”®æŒ‡ä»¤

è¿™äº›æµ‹è¯•**ä¸éœ€è¦ WSL/Linux ç¯å¢ƒ**ï¼Œä¸ä¾èµ– clang æˆ– qemuï¼Œå¯åœ¨ Windows ä¸Šç›´æ¥è¿è¡Œã€‚

---

## é˜¶æ®µ 2ï¼šæ‰¹é‡æ±‡ç¼–ç”Ÿæˆï¼ˆ`make generate-asm`ï¼‰

### è„šæœ¬ï¼š[generate_asm.sh](../scripts/generate_asm.sh)

```bash
# è°ƒç”¨æ–¹å¼
make generate-asm
# ç­‰ä»·äº
bash scripts/generate_asm.sh examples/compiler_inputs
```

**æµç¨‹**ï¼š

```
å¯¹äº examples/compiler_inputs/ ä¸‹çš„æ¯ä¸ª .c æ–‡ä»¶ï¼š

1. ToyC ç¼–è¯‘ï¼š
   ./build/toyc input.c -o test/asm/XX_toyc.s
   
2. Clang å‚è€ƒç¼–è¯‘ï¼ˆå¦‚æœå®‰è£…äº† clangï¼‰ï¼š
   clang -S --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
         -O0 input.c -o test/asm/XX_clang.s
```

**å…³é”®å‚æ•°è§£é‡Š**ï¼š
- `--target=riscv32-unknown-elf` â€” RISC-V 32 ä½è£¸æœºç›®æ ‡
- `-march=rv32im` â€” æ”¯æŒæ•´æ•°ï¼ˆIï¼‰å’Œä¹˜é™¤ï¼ˆMï¼‰æ‰©å±•
- `-mabi=ilp32` â€” int/long/pointer å‡ä¸º 32 ä½
- `-O0` â€” æ— ä¼˜åŒ–ï¼ˆä¾¿äºä¸ ToyC å¯¹æ¯”ï¼‰
- `-S` â€” åªç”Ÿæˆæ±‡ç¼–ï¼Œä¸é“¾æ¥

**è¾“å‡ºç›®å½•ç»“æ„**ï¼š
```
test/asm/
    01_minimal_toyc.s        # ToyC ç”Ÿæˆ
    01_minimal_clang.s       # Clang å‚è€ƒ
    02_assignment_toyc.s
    02_assignment_clang.s
    ...
```

### ToyC çš„ CLI è°ƒç”¨

ToyC ç¼–è¯‘å™¨ï¼ˆ[main.cpp](../src/main.cpp)ï¼‰æ”¯æŒä»¥ä¸‹æ¨¡å¼ï¼š

| å‚æ•° | åŠŸèƒ½ | è¾“å‡º |
|------|------|------|
| `toyc input.c --ast` | æ‰“å° AST | stdout |
| `toyc input.c --ir` | æ‰“å° LLVM IR | stdout |
| `toyc input.c --asm` | æ‰“å° RISC-V æ±‡ç¼– | stdout |
| `toyc input.c --all` | ä¾æ¬¡æ‰“å° AST/IR/ASM | stdout |
| `toyc input.c -o file.s` | å°†æ±‡ç¼–å†™å…¥æ–‡ä»¶ | æŒ‡å®šæ–‡ä»¶ |
| `toyc input.c` | åŒ `--all` | stdout |

`generate_asm.sh` ä½¿ç”¨ `-o` æ¨¡å¼å°†æ±‡ç¼–ç›´æ¥å†™å…¥æ–‡ä»¶ã€‚

---

## é˜¶æ®µ 3ï¼šæ‰¹é‡ IR ç”Ÿæˆï¼ˆ`make generate-ir`ï¼‰

### è„šæœ¬ï¼š[generate_ir.sh](../scripts/generate_ir.sh)

```bash
make generate-ir
# ç­‰ä»·äº
bash scripts/generate_ir.sh examples/compiler_inputs
```

**æµç¨‹**ï¼š

```
å¯¹äºæ¯ä¸ª .c æ–‡ä»¶ï¼š

1. ToyC IRï¼š
   ./build/toyc input.c --ir 2>/dev/null | grep -v '^=== ' > test/ir/XX_toyc.ll

2. Clang IRï¼š
   clang -S -emit-llvm -O0 input.c -o test/ir/XX_clang.ll
```

**æ³¨æ„**ï¼šToyC çš„ `--ir` è¾“å‡ºåŒ…å« `=== LLVM IR ===` æ ‡é¢˜è¡Œï¼Œç”¨ `grep -v '^=== '` è¿‡æ»¤æ‰ï¼Œåªä¿ç•™çº¯ IR å†…å®¹ã€‚

**è¾“å‡º**ï¼š
```
test/ir/
    01_minimal_toyc.ll       # ToyC ç”Ÿæˆçš„ LLVM-like IR
    01_minimal_clang.ll      # Clang ç”Ÿæˆçš„æ ‡å‡† LLVM IR
```

---

## é˜¶æ®µ 4ï¼šç«¯åˆ°ç«¯éªŒè¯ï¼ˆ`make verify`ï¼‰

### è„šæœ¬ï¼š[verify_output.sh](../scripts/verify_output.sh)

è¿™æ˜¯æ ¸å¿ƒéªŒè¯è„šæœ¬ï¼Œå®Œæˆä»æ±‡ç¼–åˆ°å¯¹æ¯”çš„å…¨éƒ¨æµç¨‹ã€‚

```bash
make verify
# ç­‰ä»·äº
make generate-asm && bash scripts/verify_output.sh examples/compiler_inputs
```

### 4.1 ç¯å¢ƒæ£€æµ‹

è„šæœ¬å¯åŠ¨æ—¶ä¾æ¬¡æ£€æŸ¥ï¼š

```bash
# 1. Clang æ˜¯å¦å­˜åœ¨
command -v clang

# 2. Clang æ˜¯å¦æ”¯æŒ RISC-V ç›®æ ‡
clang --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
      -c -x assembler /dev/null -o /dev/null

# 3. libgccï¼ˆè½¯ä»¶é™¤æ³•æ”¯æŒï¼‰
#    ä¼˜å…ˆä» riscv64-unknown-elf-gcc è·å– rv32im/ilp32 çš„ libgcc
riscv64-unknown-elf-gcc -march=rv32im -mabi=ilp32 -print-libgcc-file-name

# 4. QEMU RISC-V ç”¨æˆ·æ¨¡å¼ï¼ˆä¾æ¬¡å°è¯•å¤šä¸ªå‘½ä»¤åï¼‰
#    qemu-riscv32 â†’ qemu-riscv32-static â†’ qemu-riscv64 â†’ qemu-riscv64-static
```

**libgcc** æä¾›è½¯ä»¶ä¹˜é™¤æ³•ç­‰å†…ç½®å‡½æ•°ã€‚å¯¹äºåŒ…å« `div`/`rem` çš„æµ‹è¯•ï¼ˆå¦‚ `12_division_check.c`ï¼‰ï¼Œå¦‚æœç›®æ ‡ä¸æ”¯æŒ M æ‰©å±•ç¡¬ä»¶é™¤æ³•ï¼Œå°±éœ€è¦ libgccã€‚

### 4.2 ç¼–è¯‘å¯åŠ¨ä»£ç  (crt0.s)

```bash
CRT0_FILE="$SCRIPT_DIR/crt0.s"
clang --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
      -c "$CRT0_FILE" -o "$TEMP_DIR/crt0.o"
```

[crt0.s](../scripts/crt0.s) æ˜¯æœ€å°åŒ–çš„ C è¿è¡Œæ—¶å¯åŠ¨ä»£ç ï¼š

```asm
    .text
    .globl _start

_start:
    call    main          # è°ƒç”¨ main å‡½æ•°
    
    # main è¿”å›åï¼Œè¿”å›å€¼åœ¨ a0 ä¸­
    # ä½¿ç”¨ Linux RISC-V exit ç³»ç»Ÿè°ƒç”¨
    li      a7, 93        # syscall number = 93 (exit)
    ecall                 # è§¦å‘ç³»ç»Ÿè°ƒç”¨

    j       .             # é˜²å¾¡æ€§æ— é™å¾ªç¯ï¼ˆä¸åº”åˆ°è¾¾ï¼‰
```

**ä¸ºä»€ä¹ˆéœ€è¦ crt0**ï¼š
- QEMU ç”¨æˆ·æ¨¡å¼ä» `_start` å¼€å§‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥ä» `main`
- crt0 è´Ÿè´£è°ƒç”¨ `main`ï¼Œç„¶åå°† `main` çš„è¿”å›å€¼ï¼ˆa0ï¼‰ä½œä¸ºè¿›ç¨‹é€€å‡ºç ä¼ é€’ç»™ `exit` ç³»ç»Ÿè°ƒç”¨
- éªŒè¯è„šæœ¬é€šè¿‡ `$?` æ•è·é€€å‡ºç æ¥åˆ¤æ–­ç¨‹åºç»“æœ

### 4.3 æ±‡ç¼–ã€é“¾æ¥ã€è¿è¡Œ

å¯¹äºæ¯ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œè„šæœ¬åˆ†åˆ«å¤„ç† ToyC å’Œ Clang çš„æ±‡ç¼–è¾“å‡ºï¼š

```bash
# ToyC ç‰ˆæœ¬ï¼šæ±‡ç¼– + é“¾æ¥
clang --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
      -nostdlib crt0.o test/asm/XX_toyc.s [libgcc] -o XX_toyc

# Clang ç‰ˆæœ¬ï¼šæ±‡ç¼– + é“¾æ¥
clang --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
      -nostdlib crt0.o test/asm/XX_clang.s [libgcc] -o XX_clang
```

**å…³é”®å‚æ•°**ï¼š
- `-nostdlib` â€” ä¸é“¾æ¥æ ‡å‡†åº“ï¼ˆå› ä¸ºè¿™æ˜¯è£¸æœºç›®æ ‡ï¼Œæ²¡æœ‰ libcï¼‰
- `crt0.o` â€” æ‰‹åŠ¨é“¾æ¥è‡ªå®šä¹‰å¯åŠ¨ä»£ç 
- `$LIBGCC_PATH` â€” å¯é€‰ï¼Œæä¾›è½¯ä»¶é™¤æ³•ç­‰å†…ç½®å‡½æ•°

```bash
# è¿è¡Œå¹¶æ•è·é€€å‡ºç 
toyc_output=$(qemu-riscv32 XX_toyc 2>&1)
toyc_exitcode=$?

clang_output=$(qemu-riscv32 XX_clang 2>&1)
clang_exitcode=$?
```

### 4.4 ç»“æœå¯¹æ¯”

```bash
if [[ "$toyc_exitcode" -eq "$clang_exitcode" ]] && \
   [[ "$toyc_output" == "$clang_output" ]]; then
    echo "âœ… Result: CORRECT"
else
    echo "âŒ Result: INCORRECT"
fi
```

éªŒè¯ä¸¤ä¸ªç»´åº¦ï¼š
1. **é€€å‡ºç **ï¼š`main()` çš„è¿”å›å€¼ï¼Œé€šè¿‡ crt0 è½¬åŒ–ä¸ºè¿›ç¨‹é€€å‡ºç 
2. **æ ‡å‡†è¾“å‡º**ï¼šå¦‚æœæœ‰ stdout è¾“å‡ºï¼ˆæœ¬é¡¹ç›®æš‚æ—  printf æ”¯æŒï¼Œè¾“å‡ºåº”ä¸ºç©ºï¼‰

**è¾“å‡ºæ ¼å¼ç¤ºä¾‹**ï¼š
```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Testing: 01_minimal
  Clang  exit code: 42
  ToyC   exit code: 42
  âœ… Result: CORRECT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Testing: 09_recursion
  Clang  exit code: 55
  ToyC   exit code: 55
  âœ… Result: CORRECT
```

### 4.5 æœ€ç»ˆæŠ¥å‘Š

```
=========================================
  Verification Summary
=========================================
Total files:  24
Passed:       24 âœ…
Failed:       0 âŒ
Skipped:      0 âš 

ğŸ‰ All tests passed!
```

---

## é˜¶æ®µ 5ï¼šå•æ–‡ä»¶è°ƒè¯•ï¼ˆ`make debug`ï¼‰

### è„šæœ¬ï¼š[verify_debug.sh](../scripts/verify_debug.sh)

```bash
make debug FILE=01_minimal.c
# ç­‰ä»·äº
bash scripts/verify_debug.sh examples/compiler_inputs 01_minimal.c
```

ä¸“ä¸ºè°ƒè¯•å•ä¸ªæ–‡ä»¶è®¾è®¡ï¼Œè¾“å‡ºç¼–è¯‘å™¨çš„æ‰€æœ‰ä¸­é—´äº§ç‰©ï¼š

### æ­¥éª¤ 1 â€” ç”Ÿæˆ AST

```bash
./build/toyc input.c --ast > test/debug/XX_toyc_ast.txt
```

è¾“å‡º AST æ ‘çš„æ–‡æœ¬è¡¨ç¤ºï¼Œç”¨äºæ£€æŸ¥è§£ææ˜¯å¦æ­£ç¡®ã€‚

### æ­¥éª¤ 2 â€” ç”Ÿæˆ LLVM IR

```bash
./build/toyc input.c --ir | grep -v '^=== ' > test/debug/XX_toyc_ir.ll
```

è¾“å‡º LLVM-like IRï¼Œç”¨äºæ£€æŸ¥ IRBuilder æ˜¯å¦æ­£ç¡®ç”Ÿæˆäº†ç»“æ„åŒ– IRã€‚

### æ­¥éª¤ 3 â€” ç”Ÿæˆ RISC-V æ±‡ç¼–

```bash
./build/toyc input.c -o test/debug/XX_toyc_asm.s
```

è¾“å‡ºæœ€ç»ˆæ±‡ç¼–ï¼ŒåŒæ—¶æ‰“å°åˆ°ç»ˆç«¯ä¾¿äºæŸ¥çœ‹ã€‚

### æ­¥éª¤ 4 â€” Clang å‚è€ƒè¾“å‡º

```bash
# Clang IRï¼ˆæ ‡å‡† LLVM IRï¼‰
clang -S -emit-llvm -O0 input.c -o test/debug/XX_clang_ir.ll

# Clang ASMï¼ˆRISC-V æ±‡ç¼–ï¼‰
clang -S --target=riscv32-unknown-elf -march=rv32im -mabi=ilp32 \
      input.c -o test/debug/XX_clang_asm.s
```

### æ­¥éª¤ 5 â€” å¤åˆ¶åˆ°æµ‹è¯•ç›®å½•

å°†ç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ° `test/asm/` å’Œ `test/ir/` ä»¥ä¾¿åç»­éªŒè¯ã€‚

### æ­¥éª¤ 6 â€” è¿è¡ŒéªŒè¯

```bash
bash scripts/verify_output.sh examples/compiler_inputs XX.c
```

è‡ªåŠ¨è°ƒç”¨ `verify_output.sh` çš„å•æ–‡ä»¶æ¨¡å¼è¿›è¡Œç«¯åˆ°ç«¯éªŒè¯ã€‚

**è°ƒè¯•è¾“å‡ºç›®å½•ç»“æ„**ï¼š
```
test/debug/
    01_minimal_toyc_ast.txt     # ToyC AST
    01_minimal_toyc_ir.ll       # ToyC LLVM IR
    01_minimal_toyc_asm.s       # ToyC RISC-V ASM
    01_minimal_clang_ir.ll      # Clang LLVM IR ï¼ˆå‚è€ƒï¼‰
    01_minimal_clang_asm.s      # Clang RISC-V ASMï¼ˆå‚è€ƒï¼‰
```

---

## éªŒè¯åŸç†ï¼šä¸ºä»€ä¹ˆå¯¹æ¯”é€€å‡ºç å°±å¤Ÿäº†

### C ç¨‹åºçš„è¿”å›å€¼è¯­ä¹‰

æœ¬é¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹éƒ½é€šè¿‡ `main()` çš„è¿”å›å€¼ä¼ é€’è®¡ç®—ç»“æœï¼š

```c
// 01_minimal.c
int main() {
    return 42;
}

// 09_recursion.c
int fib(int n) { ... }
int main() {
    return fib(10);  // è¿”å› 55
}
```

### ä» C åˆ°é€€å‡ºç çš„å®Œæ•´é“¾è·¯

```
C æºç           main() { return 42; }
    â†“ ToyC ç¼–è¯‘
RISC-V ASM      li a0, 42 â†’ ret
    â†“ crt0.s
ç³»ç»Ÿè°ƒç”¨         call main â†’ li a7, 93 â†’ ecall
    â†“ QEMU
è¿›ç¨‹é€€å‡ºç        $? = 42
    â†“ bash
ç»“æœå¯¹æ¯”         toyc_exitcode == clang_exitcode ?
```

**æ³¨æ„**ï¼šLinux é€€å‡ºç æ˜¯ 8 ä½æ— ç¬¦å·å€¼ï¼ˆ0-255ï¼‰ï¼Œå› æ­¤æµ‹è¯•ç”¨ä¾‹çš„è¿”å›å€¼éœ€åœ¨æ­¤èŒƒå›´å†…ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ `-nostdlib`

ToyC æ˜¯ä¸€ä¸ªæ•™å­¦ç¼–è¯‘å™¨ï¼Œåªæ”¯æŒ C è¯­è¨€å­é›†ï¼Œä¸æ”¯æŒ `printf` ç­‰æ ‡å‡†åº“å‡½æ•°ã€‚ä½¿ç”¨ `-nostdlib` é¿å…äº†ï¼š
- é“¾æ¥ libc çš„å¤æ‚æ€§
- newlib/glibc çš„ RISC-V è£¸æœºç§»æ¤é—®é¢˜
- å¯åŠ¨ä»£ç å†²çªï¼ˆæ ‡å‡† crt0 vs è‡ªå®šä¹‰ crt0ï¼‰

---

## ç¯å¢ƒæ­å»ºæŒ‡å—

### Windows + WSL å·¥ä½œæµ

é¡¹ç›®åœ¨ Windows ä¸Šå¼€å‘ç¼–è¯‘ï¼Œåœ¨ WSL ä¸­è¿›è¡Œç«¯åˆ°ç«¯éªŒè¯ï¼š

```
Windows (PowerShell / VS Code)          WSL (Ubuntu)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼–è¾‘æºç                   â”‚    â”‚  æ–¹å¼ A: ç›´æ¥ä½¿ç”¨ Windows äº§ç‰©  â”‚
â”‚  make                      â”‚    â”‚  cd /mnt/d/Project/.../          â”‚
â”‚  â†’ build/toyc.exe          â”‚    â”‚  make verify                     â”‚
â”‚  â†’ build/toyc_test.exe     â”‚    â”‚  (è‡ªåŠ¨æ‰¾åˆ° build/toyc.exe)       â”‚
â”‚  make test                 â”‚    â”‚                               â”‚
â”‚  ï¼ˆ36 ä¸ªå†…ç½®æµ‹è¯•ï¼‰          â”‚    â”‚  æ–¹å¼ B: WSL åŸç”Ÿæ„å»º           â”‚
â”‚                           â”‚    â”‚  make                            â”‚
â”‚                           â”‚    â”‚  â†’ build-linux/toyc (ELF)        â”‚
â”‚                           â”‚    â”‚  make verify                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WSL ç¯å¢ƒå®‰è£…

```bash
# 1. å®‰è£… Clangï¼ˆéœ€æ”¯æŒ RISC-V åç«¯ï¼‰
sudo apt install clang

# 2. å®‰è£… QEMU ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿå™¨
sudo apt install qemu-user

# 3. [å¯é€‰] å®‰è£… RISC-V GCC å·¥å…·é“¾ï¼ˆæä¾› libgccï¼‰
sudo apt install gcc-riscv64-unknown-elf

# 4. éªŒè¯å®‰è£…
clang --target=riscv32-unknown-elf -march=rv32im -v 2>&1 | head -5
qemu-riscv32 --version
```

### å¿«é€ŸéªŒè¯

```bash
# åœ¨ WSL ä¸­ï¼Œåˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd /mnt/d/Project/FINISHED/C-SubsetCompilerUsingLLVM

# æ–¹å¼ A: ç¡®ä¿å·²åœ¨ Windows ä¾§ç¼–è¯‘ â†’ build/toyc.exe å­˜åœ¨
# WSL å¯ä»¥ç›´æ¥è¿è¡Œ .exe
make verify

# æ–¹å¼ B: åœ¨ WSL ä¸­ç¼–è¯‘ Linux åŸç”ŸäºŒè¿›åˆ¶ â†’ build-linux/toyc
make
make verify

# è°ƒè¯•å•ä¸ªæ–‡ä»¶
make debug FILE=09_recursion.c
```

---

## æµ‹è¯•ç”¨ä¾‹æ¦‚è§ˆ

[examples/compiler_inputs/](../examples/compiler_inputs/) ç›®å½•åŒ…å« 24 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š

| æ–‡ä»¶ | æµ‹è¯•ç‰¹æ€§ | æœŸæœ›è¿”å›å€¼ |
|------|---------|-----------|
| 01_minimal.c | æœ€å°ç¨‹åº | 42 |
| 02_assignment.c | å˜é‡èµ‹å€¼ | 30 |
| 03_if_else.c | if-else åˆ†æ”¯ | è§†æ¡ä»¶è€Œå®š |
| 04_while_break.c | while + break | å¾ªç¯ç»“æœ |
| 05_function_call.c | å‡½æ•°è°ƒç”¨ | è°ƒç”¨ç»“æœ |
| 06_continue.c | continue è¯­å¥ | å¾ªç¯ç»“æœ |
| 07_scope_shadow.c | å˜é‡é®è”½ | å†…å±‚ä½œç”¨åŸŸå€¼ |
| 08_short_circuit.c | çŸ­è·¯æ±‚å€¼ (\|\| &&) | é€»è¾‘ç»“æœ |
| 09_recursion.c | é€’å½’ï¼ˆæ–æ³¢é‚£å¥‘ï¼‰ | 55 |
| 10_void_fn.c | void å‡½æ•° | 0 |
| 11_precedence.c | è¿ç®—ç¬¦ä¼˜å…ˆçº§ | è®¡ç®—ç»“æœ |
| 12_division_check.c | é™¤æ³•/å–æ¨¡ | è®¡ç®—ç»“æœ |
| 13_scope_block.c | å—ä½œç”¨åŸŸ | ä½œç”¨åŸŸå€¼ |
| 14_nested_if_while.c | åµŒå¥— if+while | å¤åˆç»“æœ |
| 15_multiple_return_paths.c | å¤šè¿”å›è·¯å¾„ | æ¡ä»¶ç»“æœ |
| 16-24 | ç»¼åˆæµ‹è¯• | å„å¼‚ |

æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹çš„æ­£ç¡®æ€§ç”± Clang `-O0` ç¼–è¯‘ç»“æœä½œä¸ºå‚è€ƒåŸºå‡†ï¼ˆground truthï¼‰ã€‚

---

## è„šæœ¬é—´çš„åä½œå…³ç³»

```
Makefile
â”œâ”€â”€ make generate-asm â†’ scripts/generate_asm.sh
â”‚   â””â”€â”€ äº§å‡º: test/asm/*_toyc.s, test/asm/*_clang.s
â”‚
â”œâ”€â”€ make generate-ir  â†’ scripts/generate_ir.sh
â”‚   â””â”€â”€ äº§å‡º: test/ir/*_toyc.ll, test/ir/*_clang.ll
â”‚
â”œâ”€â”€ make verify       â†’ make generate-asm + scripts/verify_output.sh
â”‚   â”œâ”€â”€ ä¾èµ–: test/asm/*, scripts/crt0.s
â”‚   â””â”€â”€ æµç¨‹: ç¼–è¯‘crt0 â†’ é“¾æ¥æ±‡ç¼– â†’ QEMUè¿è¡Œ â†’ å¯¹æ¯”
â”‚
â””â”€â”€ make debug FILE=x â†’ scripts/verify_debug.sh
    â”œâ”€â”€ æ­¥éª¤1-3: ç”Ÿæˆ AST/IR/ASM
    â”œâ”€â”€ æ­¥éª¤4:   ç”Ÿæˆ Clang å‚è€ƒ
    â”œâ”€â”€ æ­¥éª¤5:   å¤åˆ¶åˆ° test/asm/ å’Œ test/ir/
    â””â”€â”€ æ­¥éª¤6:   è°ƒç”¨ verify_output.sh è¿›è¡Œå•æ–‡ä»¶éªŒè¯
```

æ‰€æœ‰è„šæœ¬ä¼šè‡ªåŠ¨æœç´¢ `./build-linux/toyc`ã€`./build/toyc` æˆ– `./build/toyc.exe`ï¼ŒåŒæ—¶æ”¯æŒ Windows (WSL è·¯å¾„) å’Œ Linux ç¯å¢ƒã€‚
