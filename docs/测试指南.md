# ToyC ç¼–è¯‘å™¨æµ‹è¯•æŒ‡å—

## ç›®å½•
- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ‰¹é‡æµ‹è¯•](#æ‰¹é‡æµ‹è¯•)
- [å•æ–‡ä»¶æµ‹è¯•](#å•æ–‡ä»¶æµ‹è¯•)
- [è¾“å‡ºè¯´æ˜](#è¾“å‡ºè¯´æ˜)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®ç®€ä»‹

ToyC æ˜¯ä¸€ä¸ªåŸºäº LLVM çš„ C è¯­è¨€å­é›†ç¼–è¯‘å™¨ï¼Œæ”¯æŒå°† C ä»£ç ç¼–è¯‘ä¸ºï¼š
- **AST** (æŠ½è±¡è¯­æ³•æ ‘)
- **LLVM IR** (ä¸­é—´è¡¨ç¤º)
- **RISC-V æ±‡ç¼–** (RV32I æŒ‡ä»¤é›†)

é¡¹ç›®ç‰¹ç‚¹ï¼š
- ä½¿ç”¨ C++20 ç¼–å†™
- å®ç°äº†çº¿æ€§æ‰«æå¯„å­˜å™¨åˆ†é…ç®—æ³•
- æ”¯æŒå‡½æ•°è°ƒç”¨ã€æ§åˆ¶æµã€é€»è¾‘è¿ç®—ç­‰åŸºæœ¬è¯­æ³•

---

## ç¯å¢ƒè¦æ±‚

### å¿…éœ€å·¥å…·
- **g++** (æ”¯æŒ C++20): ç”¨äºç¼–è¯‘ ToyC ç¼–è¯‘å™¨æœ¬èº«
- **make**: ç”¨äºæ„å»ºå’Œæµ‹è¯•è‡ªåŠ¨åŒ–
- **bash**: ç”¨äºè¿è¡Œæµ‹è¯•è„šæœ¬

### å¯é€‰å·¥å…·ï¼ˆç”¨äºç”Ÿæˆå¯¹æ¯”è¾“å‡ºï¼‰
- **clang**: ç”Ÿæˆæ ‡å‡† LLVM IR å’Œ RISC-V æ±‡ç¼–ç”¨äºå¯¹æ¯”
- **riscv32-unknown-elf-gcc**: ç”Ÿæˆ RISC-V GCC æ±‡ç¼–ç”¨äºå¯¹æ¯”

### WSL/Linux ç¯å¢ƒ
```bash
# Ubuntu/Debian
sudo apt install build-essential clang

# å®‰è£… RISC-V å·¥å…·é“¾ (å¯é€‰)
sudo apt install gcc-riscv64-unknown-elf
```

---

## å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†å¹¶è¿›å…¥é¡¹ç›®ç›®å½•
```bash
cd d:/Project/C-SubsetCompilerUsingLLVM
```

### 2. æ¸…ç†å¹¶æ„å»º
```bash
make clean
make build
```

### 3. è¿è¡Œå®Œæ•´æµ‹è¯•
```bash
make test
```

æµ‹è¯•å°†è‡ªåŠ¨ï¼š
1. ç¼–è¯‘ ToyC ç¼–è¯‘å™¨
2. å¤„ç† `examples/compiler_inputs/` ä¸‹çš„æ‰€æœ‰ `.c` æ–‡ä»¶
3. ç”Ÿæˆæ±‡ç¼–ä»£ç åˆ° `test/asm/` ç›®å½•
4. ç”Ÿæˆ LLVM IR åˆ° `test/ir/` ç›®å½•

---

## æ‰¹é‡æµ‹è¯•

### æµ‹è¯•æ‰€æœ‰ç¤ºä¾‹æ–‡ä»¶
```bash
make test
```

**è¾“å‡ºç›®å½•ç»“æ„ï¼š**
```
test/
â”œâ”€â”€ asm/                          # æ±‡ç¼–ä»£ç è¾“å‡º
â”‚   â”œâ”€â”€ 01_minimal_toyc.s         # ToyC ç”Ÿæˆçš„æ±‡ç¼–
â”‚   â”œâ”€â”€ 01_minimal_clang.s        # Clang ç”Ÿæˆçš„æ±‡ç¼–ï¼ˆå¯¹æ¯”ç”¨ï¼‰
â”‚   â”œâ”€â”€ 02_assignment_toyc.s
â”‚   â””â”€â”€ ...
â””â”€â”€ ir/                           # LLVM IR è¾“å‡º
    â”œâ”€â”€ 01_minimal_toyc.ll        # ToyC ç”Ÿæˆçš„ IR
    â”œâ”€â”€ 01_minimal_clang.ll       # Clang ç”Ÿæˆçš„ IRï¼ˆå¯¹æ¯”ç”¨ï¼‰
    â””â”€â”€ ...
```

### ä»…ç”Ÿæˆæ±‡ç¼–
```bash
bash scripts/generate_asm.sh
```

### ä»…ç”Ÿæˆ IR
```bash
bash scripts/generate_ir.sh
```

### éªŒè¯è¾“å‡ºæ­£ç¡®æ€§

**è‡ªåŠ¨ç¼–è¯‘è¿è¡Œå¹¶éªŒè¯ç»“æœ**ï¼š
```bash
make verify
```

è¿™ä¸ªå‘½ä»¤ä¼šï¼š
1. è‡ªåŠ¨è¿è¡Œ `make test` ç”Ÿæˆæ±‡ç¼–ä»£ç 
2. ä½¿ç”¨ RISC-V GCC ç¼–è¯‘ ToyC å’Œ Clang ç”Ÿæˆçš„æ±‡ç¼–
3. ä½¿ç”¨ QEMU è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
4. å¯¹æ¯”é€€å‡ºç å’Œè¾“å‡ºï¼Œåˆ¤æ–­ç»“æœæ˜¯å¦æ­£ç¡®

**ç¯å¢ƒè¦æ±‚**ï¼š
- `riscv32-unknown-elf-gcc` æˆ– `riscv64-unknown-elf-gcc`ï¼ˆRISC-V äº¤å‰ç¼–è¯‘å™¨ï¼‰
- `qemu-riscv32`ã€`qemu-riscv64` æˆ–å…¶ static ç‰ˆæœ¬ï¼ˆQEMU æ¨¡æ‹Ÿå™¨ï¼‰

**å®‰è£…æ–¹æ³•**ï¼š
```bash
# Ubuntu/Debian
sudo apt install gcc-riscv64-unknown-elf qemu-user

# Arch Linux
sudo pacman -S riscv64-elf-gcc qemu-arch-extra

# æ³¨æ„ï¼šéªŒè¯è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¯ç”¨çš„å·¥å…·é“¾
# riscv64 å·¥å…·é“¾ä¹Ÿå¯ä»¥ç¼–è¯‘å’Œè¿è¡Œ RV32 ä»£ç 
```

**éªŒè¯è¾“å‡ºç¤ºä¾‹**ï¼š
```
=========================================
  ToyC Compiler Output Verification
=========================================
Source directory: examples/compiler_inputs
Assembly directory: test/asm
QEMU command: qemu-riscv32

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Testing: 01_minimal
  Clang  exit code: 0
  ToyC   exit code: 0
  âœ… Result: CORRECT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Testing: 05_function_call
  Clang  exit code: 30
  ToyC   exit code: 30
  âœ… Result: CORRECT
=========================================
  Verification Summary
=========================================
Total tests:  15
Passed:       15 âœ…
Failed:       0 âŒ

ğŸ‰ All tests passed!
```

### è‡ªå®šä¹‰ç›®å½•éªŒè¯

```bash
# éªŒè¯è‡ªå®šä¹‰ç›®å½•
make verify TEST_SRC_DIR=examples/single_func

# æˆ–ç›´æ¥è°ƒç”¨è„šæœ¬
bash scripts/verify_output.sh examples/multi_func
```

### æ¸…ç†æµ‹è¯•è¾“å‡º
```bash
rm -rf test/asm test/ir
# æˆ–è€…æ¸…ç†æ‰€æœ‰æ„å»ºäº§ç‰©
make clean
```

---

## å•æ–‡ä»¶æµ‹è¯•

### ç¼–è¯‘ C åˆ° RISC-V æ±‡ç¼–
```bash
./toyc examples/compiler_inputs/01_minimal.c --mode asm --output output.s
```

### ç¼–è¯‘ C åˆ° LLVM IR
```bash
./toyc examples/compiler_inputs/01_minimal.c --mode ir --output output.ll
```

### æŸ¥çœ‹ AST
```bash
./toyc examples/compiler_inputs/01_minimal.c --mode ast
```

### å®Œæ•´æµç¨‹ï¼ˆAST + IR + ASMï¼‰
```bash
./toyc examples/compiler_inputs/01_minimal.c --mode all
```

### ä½¿ç”¨æ ‡å‡†è¾“å…¥
```bash
cat examples/compiler_inputs/01_minimal.c | ./toyc --mode asm
```

---

## è¾“å‡ºè¯´æ˜

### æ±‡ç¼–è¾“å‡ºæ ¼å¼
ç”Ÿæˆçš„ RISC-V æ±‡ç¼–éµå¾ª RV32I æ ‡å‡†ï¼š
- ä½¿ç”¨ `.text` æ®µå­˜æ”¾ä»£ç 
- ä½¿ç”¨ `.data` æ®µå­˜æ”¾æ•°æ®
- å¯„å­˜å™¨åˆ†é…ç¬¦åˆ RISC-V è°ƒç”¨çº¦å®šï¼š
  - `a0-a7`: å‚æ•°å¯„å­˜å™¨
  - `t0-t6`: ä¸´æ—¶å¯„å­˜å™¨
  - `s0-s11`: ä¿å­˜å¯„å­˜å™¨
  - `ra`: è¿”å›åœ°å€å¯„å­˜å™¨

### IR è¾“å‡ºæ ¼å¼
ç”Ÿæˆçš„ LLVM IR åŒ…å«ï¼š
- å‡½æ•°å®šä¹‰
- åŸºæœ¬å—ç»“æ„
- SSA å½¢å¼çš„æŒ‡ä»¤
- ç±»å‹ä¿¡æ¯

```bash
# å¯¹æ¯”æ±‡ç¼–
diff test/asm/01_minimal_toyc.s test/asm/01_minimal_clang.s

# å¯¹æ¯” IR
diff test/ir/01_minimal_toyc.ll test/ir/01_minimal_clang.ll
```

---

## æµ‹è¯•ç”¨ä¾‹è¯´æ˜

å½“å‰é¡¹ç›®åŒ…å«ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼ˆä½äº `examples/compiler_inputs/`ï¼‰ï¼š

| æ–‡ä»¶ | æµ‹è¯•åŠŸèƒ½ |
|-----|---------|
| `01_minimal.c` | æœ€å°ç¨‹åºï¼ˆç©º mainï¼‰ |
| `02_assignment.c` | å˜é‡èµ‹å€¼ |
| `03_if_else.c` | if-else æ¡ä»¶è¯­å¥ |
| `04_while_break.c` | while å¾ªç¯å’Œ break |
| `05_function_call.c` | å‡½æ•°è°ƒç”¨ |
| `06_continue.c` | continue è¯­å¥ |
| `07_scope_shadow.c` | ä½œç”¨åŸŸå’Œå˜é‡é®è”½ |
| `08_short_circuit.c` | é€»è¾‘çŸ­è·¯æ±‚å€¼ |
| `09_recursion.c` | é€’å½’å‡½æ•° |
| `10_void_fn.c` | void å‡½æ•° |
| `11_precedence.c` | è¿ç®—ç¬¦ä¼˜å…ˆçº§ |
| `12_division_check.c` | é™¤æ³•æ£€æŸ¥ |
| `13_scope_block.c` | å—ä½œç”¨åŸŸ |
| `14_nested_if_while.c` | åµŒå¥—æ§åˆ¶æµ |
| `15_multiple_return_paths.c` | å¤šè¿”å›è·¯å¾„ |

---

## å¼€å‘è€…æç¤º

### ä¿®æ”¹ç¼–è¯‘å™¨åé‡æ–°æµ‹è¯•
```bash
make clean
make test
```

### è°ƒè¯•å•ä¸ªæµ‹è¯•ç”¨ä¾‹
```bash
# 1. ç¼–è¯‘ç¼–è¯‘å™¨
make build

# 2. è¿è¡Œå•ä¸ªæ–‡ä»¶å¹¶æŸ¥çœ‹è¯¦ç»†è¾“å‡º
./toyc examples/compiler_inputs/01_minimal.c --mode all

# 3. å¯¹æ¯”è¾“å‡º
clang -S --target=riscv32 -march=rv32i examples/compiler_inputs/01_minimal.c -o ref.s
diff ref.s test/asm/01_minimal_toyc.s
```

### æ€§èƒ½æµ‹è¯•
```bash
time make test
```
