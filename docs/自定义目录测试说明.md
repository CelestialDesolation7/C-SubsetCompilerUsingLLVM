# è‡ªå®šä¹‰ç›®å½•æ‰¹é‡æµ‹è¯•ç¤ºä¾‹

## åŠŸèƒ½è¯´æ˜

ç°åœ¨æ”¯æŒå¯¹ä»»æ„ç›®å½•ä¸‹çš„ C æ–‡ä»¶è¿›è¡Œæ‰¹é‡æµ‹è¯•ï¼

## ä½¿ç”¨æ–¹æ³•

### 1. é»˜è®¤æµ‹è¯•ï¼ˆexamples/compiler_inputsï¼‰

```bash
make test
```

è¿™ä¼šæµ‹è¯• `examples/compiler_inputs/` ç›®å½•ä¸‹çš„æ‰€æœ‰ `.c` æ–‡ä»¶ã€‚

### 2. è‡ªå®šä¹‰ç›®å½•æµ‹è¯•

```bash
make test TEST_SRC_DIR=<your_directory>
```

ä¾‹å¦‚ï¼š

```bash
# æµ‹è¯• single_func ç›®å½•
make test TEST_SRC_DIR=examples/single_func

# æµ‹è¯• multi_func ç›®å½•
make test TEST_SRC_DIR=examples/multi_func

# æµ‹è¯•è‡ªå·±çš„æµ‹è¯•ç›®å½•
make test TEST_SRC_DIR=my_tests
```

### 3. éªŒè¯è¾“å‡ºç»“æœ

```bash
# éªŒè¯é»˜è®¤ç›®å½•
make verify

# éªŒè¯è‡ªå®šä¹‰ç›®å½•
make verify TEST_SRC_DIR=<your_directory>

# ç¤ºä¾‹
make verify TEST_SRC_DIR=examples/single_func
make verify TEST_SRC_DIR=examples/multi_func
```

### 4. ä½¿ç”¨è„šæœ¬ç›´æ¥æµ‹è¯•

```bash
# ç”Ÿæˆæ±‡ç¼–
bash scripts/generate_asm.sh <directory>

# ç”Ÿæˆ IR
bash scripts/generate_ir.sh <directory>

# ç¤ºä¾‹
bash scripts/generate_asm.sh examples/single_func
bash scripts/generate_ir.sh examples/multi_func

# éªŒè¯è¾“å‡º
bash scripts/verify_output.sh examples/single_func
```

## è¾“å‡ºä½ç½®

æ— è®ºæµ‹è¯•å“ªä¸ªç›®å½•ï¼Œè¾“å‡ºéƒ½ç»Ÿä¸€åœ¨ `test/` ç›®å½•ä¸‹ï¼š

```
test/
â”œâ”€â”€ asm/          # æ±‡ç¼–è¾“å‡º
â”‚   â”œâ”€â”€ <file1>_toyc.s
â”‚   â”œâ”€â”€ <file1>_clang.s
â”‚   â””â”€â”€ ...
â””â”€â”€ ir/           # IR è¾“å‡º
    â”œâ”€â”€ <file1>_toyc.ll
    â”œâ”€â”€ <file1>_clang.ll
    â””â”€â”€ ...
```

## ç¤ºä¾‹å·¥ä½œæµ

### åœºæ™¯ 1: æµ‹è¯•æ–°åŠŸèƒ½

```bash
# 1. åˆ›å»ºæµ‹è¯•ç›®å½•
mkdir my_new_feature_tests

# 2. æ·»åŠ æµ‹è¯•æ–‡ä»¶
cat > my_new_feature_tests/test_array.c << 'EOF'
int main() {
    int x = 42;
    return x;
}
EOF

# 3. è¿è¡Œæµ‹è¯•
make test TEST_SRC_DIR=my_new_feature_tests

# 4. æŸ¥çœ‹è¾“å‡º
ls test/asm/
ls test/ir/
```

### åœºæ™¯ 2: å¯¹æ¯”ä¸åŒæµ‹è¯•é›†

```bash
# æµ‹è¯•åŸºç¡€åŠŸèƒ½
make test TEST_SRC_DIR=examples/compiler_inputs

# æ¸…ç†è¾“å‡º
rm -rf test/asm test/ir

# æµ‹è¯•å¤æ‚åŠŸèƒ½
make test TEST_SRC_DIR=examples/multi_func

# å¯¹æ¯”ç»“æœ
ls test/asm/
```

### åœºæ™¯ 3: ä»…ç”Ÿæˆæ±‡ç¼–æˆ– IR

```bash
# åªæƒ³çœ‹æŸä¸ªç›®å½•çš„æ±‡ç¼–è¾“å‡º
bash scripts/generate_asm.sh examples/single_func

# åªæƒ³çœ‹æŸä¸ªç›®å½•çš„ IR è¾“å‡º
bash scripts/generate_ir.sh examples/multi_func
```

### åœºæ™¯ 4: éªŒè¯è¾“å‡ºæ­£ç¡®æ€§

```bash
# 1. ç”Ÿæˆå¹¶éªŒè¯é»˜è®¤ç›®å½•
make verify

# 2. éªŒè¯ç‰¹å®šç›®å½•
make verify TEST_SRC_DIR=examples/single_func

# 3. æŸ¥çœ‹éªŒè¯ç»“æœ
# è„šæœ¬ä¼šè‡ªåŠ¨å¯¹æ¯” ToyC å’Œ Clang çš„è¾“å‡º
# æ˜¾ç¤º âœ… æ­£ç¡® æˆ– âŒ é”™è¯¯

# 4. å¦‚æœå‘ç°é”™è¯¯ï¼Œå¯ä»¥æŸ¥çœ‹è¯¦ç»†çš„æ±‡ç¼–ä»£ç 
cat test/asm/test_name_toyc.s
cat test/asm/test_name_clang.s
```

## æ³¨æ„äº‹é¡¹

1. **ç›®å½•å¿…é¡»å­˜åœ¨**: å¦‚æœæŒ‡å®šçš„ç›®å½•ä¸å­˜åœ¨ï¼Œè„šæœ¬ä¼šæŠ¥é”™
2. **å¿…é¡»åŒ…å« .c æ–‡ä»¶**: ç›®å½•ä¸‹å¿…é¡»æœ‰è‡³å°‘ä¸€ä¸ª `.c` æ–‡ä»¶
3. **è¾“å‡ºä¼šè¦†ç›–**: æ¯æ¬¡æµ‹è¯•ä¼šè¦†ç›– `test/asm` å’Œ `test/ir` ä¸‹çš„åŒåæ–‡ä»¶
4. **å¯¹æ¯”è¾“å‡ºå¯é€‰**: å¦‚æœæ²¡æœ‰å®‰è£… clang æˆ– riscv-gccï¼Œä¼šè·³è¿‡å¯¹æ¯”è¾“å‡º

## å¸¸è§é”™è¯¯

### é”™è¯¯ 1: ç›®å½•ä¸å­˜åœ¨

```bash
$ make test TEST_SRC_DIR=nonexistent
Error: Source directory 'nonexistent' does not exist
```

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ç›®å½•è·¯å¾„æ˜¯å¦æ­£ç¡®

### é”™è¯¯ 2: æ²¡æœ‰ .c æ–‡ä»¶

```bash
$ make test TEST_SRC_DIR=empty_dir
No .c files found in empty_dir
```

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ç›®å½•ä¸‹æœ‰ `.c` æ–‡ä»¶

### é”™è¯¯ 3: éªŒè¯æ—¶ç¼ºå°‘å·¥å…·

```bash
$ make verify
Error: riscv32-unknown-elf-gcc not found
```

**è§£å†³æ–¹æ¡ˆ**: å®‰è£… RISC-V å·¥å…·é“¾å’Œ QEMU
```bash
sudo apt install gcc-riscv64-unknown-elf qemu-user
```

## é«˜çº§ç”¨æ³•

### æ‰¹é‡æµ‹è¯•å’ŒéªŒè¯å¤šä¸ªç›®å½•

```bash
#!/bin/bash
# æµ‹è¯•å¹¶éªŒè¯æ‰€æœ‰ç¤ºä¾‹ç›®å½•

for dir in examples/compiler_inputs examples/single_func examples/multi_func; do
    echo "========================================="
    echo "Testing and verifying $dir..."
    echo "========================================="
    
    # æµ‹è¯•
    make test TEST_SRC_DIR=$dir
    
    # éªŒè¯
    make verify TEST_SRC_DIR=$dir
    
    # å¤‡ä»½è¾“å‡º
    mkdir -p backups/$(basename $dir)
    cp -r test/asm backups/$(basename $dir)/
    cp -r test/ir backups/$(basename $dir)/
    echo ""
done

echo "ğŸ‰ All tests and verifications completed!"
```

### å¯¹æ¯”æµ‹è¯•ç»“æœ

```bash
# å¯¹æ¯”ä¸¤æ¬¡æµ‹è¯•çš„æ±‡ç¼–è¾“å‡º
diff -r test/asm/ backups/compiler_inputs/asm/
```

## æ€»ç»“

æ–°çš„æµ‹è¯•ç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œæ”¯æŒï¼š
- âœ… é»˜è®¤æµ‹è¯•ç›®å½•
- âœ… è‡ªå®šä¹‰æµ‹è¯•ç›®å½•
- âœ… ç»Ÿä¸€è¾“å‡ºä½ç½®
- âœ… ç‹¬ç«‹çš„è„šæœ¬è°ƒç”¨
- âœ… è‡ªåŠ¨ç›®å½•æ£€æŸ¥
- âœ… **è¾“å‡ºç»“æœéªŒè¯** (æ–°å¢!)
- âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•å’Œå¯¹æ¯”** (æ–°å¢!)

## å®Œæ•´æµ‹è¯•æµç¨‹

æ¨èçš„å®Œæ•´æµ‹è¯•æµç¨‹ï¼š

```bash
# 1. ç¼–è¯‘é¡¹ç›®
make build

# 2. ç”Ÿæˆæµ‹è¯•è¾“å‡ºï¼ˆæ±‡ç¼–å’Œ IRï¼‰
make test TEST_SRC_DIR=examples/compiler_inputs

# 3. éªŒè¯è¾“å‡ºæ­£ç¡®æ€§
make verify TEST_SRC_DIR=examples/compiler_inputs

# 4. å¦‚æœéœ€è¦ï¼ŒæŸ¥çœ‹å…·ä½“çš„è¾“å‡ºæ–‡ä»¶
ls test/asm/
ls test/ir/

# 5. æ¸…ç†
make clean
```

æˆ–è€…ä¸€æ¡å‘½ä»¤å®Œæˆæµ‹è¯•å’ŒéªŒè¯ï¼š
```bash
make verify TEST_SRC_DIR=examples/compiler_inputs
```

è¿™ä½¿å¾—æµ‹è¯•å’ŒéªŒè¯æ–°åŠŸèƒ½å˜å¾—æ›´åŠ æ–¹ä¾¿ï¼
